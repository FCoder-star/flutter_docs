# Flutter å¤šçº¿ç¨‹ç¼–ç¨‹å®Œå…¨æŒ‡å—

> æ·±å…¥ç†è§£ Flutter å¤šçº¿ç¨‹çš„åŸç†ã€å®è·µä¸æœ€ä½³å®è·µ

---

## ç›®å½•

- [ä¸€ã€å¼•è¨€](#ä¸€å¼•è¨€)
  - [1.1 æ–‡æ¡£ç›®æ ‡ä¸è¯»è€…å®šä½](#11-æ–‡æ¡£ç›®æ ‡ä¸è¯»è€…å®šä½)
  - [1.2 Flutter å¹¶å‘ç¼–ç¨‹çš„æŒ‘æˆ˜ä¸ç—›ç‚¹](#12-flutter-å¹¶å‘ç¼–ç¨‹çš„æŒ‘æˆ˜ä¸ç—›ç‚¹)
  - [1.3 ä¸ºä»€ä¹ˆéœ€è¦å¤šçº¿ç¨‹ï¼Ÿ](#13-ä¸ºä»€ä¹ˆéœ€è¦å¤šçº¿ç¨‹)
  - [1.4 æ–‡æ¡£ç»“æ„å¯¼è§ˆ](#14-æ–‡æ¡£ç»“æ„å¯¼è§ˆ)

- [äºŒã€Flutter å¹¶å‘æ¨¡å‹æ·±åº¦è§£æ](#äºŒflutter-å¹¶å‘æ¨¡å‹æ·±åº¦è§£æ)
  - [2.1 UI çº¿ç¨‹ä¸äº‹ä»¶å¾ªç¯æœºåˆ¶](#21-ui-çº¿ç¨‹ä¸äº‹ä»¶å¾ªç¯æœºåˆ¶)
  - [2.2 Isolate çš„æœ¬è´¨ä¸è®¾è®¡å“²å­¦](#22-isolate-çš„æœ¬è´¨ä¸è®¾è®¡å“²å­¦)
  - [2.3 å¼‚æ­¥ï¼ˆasync/awaitï¼‰vs å¹¶å‘ï¼ˆIsolateï¼‰](#23-å¼‚æ­¥asyncawait-vs-å¹¶å‘isolate)
  - [2.4 æ¶ˆæ¯ä¼ é€’æœºåˆ¶æ·±åº¦è§£æ](#24-æ¶ˆæ¯ä¼ é€’æœºåˆ¶æ·±åº¦è§£æ)

- [ä¸‰ã€Isolate åŸç”Ÿ API æ·±åº¦è¯¦è§£](#ä¸‰isolate-åŸç”Ÿ-api-æ·±åº¦è¯¦è§£)
  - [3.1 æ ¸å¿ƒ API è¯´æ˜](#31-æ ¸å¿ƒ-api-è¯´æ˜)
  - [3.2 åº•å±‚åŸç†ä¸å·¥ä½œæœºåˆ¶](#32-åº•å±‚åŸç†ä¸å·¥ä½œæœºåˆ¶)
  - [3.3 åŒå‘é€šä¿¡æ¨¡å¼è¯¦è§£](#33-åŒå‘é€šä¿¡æ¨¡å¼è¯¦è§£)
  - [3.4 æ•°æ®åºåˆ—åŒ–æ·±åº¦åˆ†æ](#34-æ•°æ®åºåˆ—åŒ–æ·±åº¦åˆ†æ)
  - [3.5 ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ€ä½³å®è·µ](#35-ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ€ä½³å®è·µ)
  - [3.6 é”™è¯¯å¤„ç†ä¸å¼‚å¸¸ä¼ æ’­](#36-é”™è¯¯å¤„ç†ä¸å¼‚å¸¸ä¼ æ’­)
  - [3.7 å®æˆ˜ä»£ç ç¤ºä¾‹](#37-å®æˆ˜ä»£ç ç¤ºä¾‹)
  - [3.8 æ€§èƒ½åˆ†æä¸æƒè¡¡](#38-æ€§èƒ½åˆ†æä¸æƒè¡¡)
  - [3.9 å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ](#39-å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ)
  - [3.10 é€‚ç”¨åœºæ™¯å†³ç­–æ ‘](#310-é€‚ç”¨åœºæ™¯å†³ç­–æ ‘)

- [å››ã€compute å‡½æ•°æ·±åº¦è¯¦è§£](#å››compute-å‡½æ•°æ·±åº¦è¯¦è§£)
  - [4.1 æ ¸å¿ƒ API ä¸è®¾è®¡ç†å¿µ](#41-æ ¸å¿ƒ-api-ä¸è®¾è®¡ç†å¿µ)
  - [4.2 å‡½æ•°é™åˆ¶æ·±åº¦è§£æ](#42-å‡½æ•°é™åˆ¶æ·±åº¦è§£æ)
  - [4.3 è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†æœºåˆ¶](#43-è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†æœºåˆ¶)
  - [4.4 æ€§èƒ½å¼€é”€æ·±åº¦åˆ†æ](#44-æ€§èƒ½å¼€é”€æ·±åº¦åˆ†æ)
  - [4.5 å®æˆ˜ä»£ç ç¤ºä¾‹](#45-å®æˆ˜ä»£ç ç¤ºä¾‹)
  - [4.6 å¸¸è§é”™è¯¯ä¸æ­£ç¡®åšæ³•å¯¹æ¯”](#46-å¸¸è§é”™è¯¯ä¸æ­£ç¡®åšæ³•å¯¹æ¯”)
  - [4.7 æ€§èƒ½ä¼˜åŒ–æŠ€å·§](#47-æ€§èƒ½ä¼˜åŒ–æŠ€å·§)
  - [4.8 é€‚ç”¨åœºæ™¯ä¸é™åˆ¶](#48-é€‚ç”¨åœºæ™¯ä¸é™åˆ¶)

- [äº”ã€Isolate.run æ·±åº¦è¯¦è§£ (Flutter 3.7+)](#äº”isolaterun-æ·±åº¦è¯¦è§£-flutter-37)
  - [5.1 æ–°ç‰¹æ€§ä¸è®¾è®¡ç›®æ ‡](#51-æ–°ç‰¹æ€§ä¸è®¾è®¡ç›®æ ‡)
  - [5.2 é—­åŒ…æ”¯æŒçš„åŸç†ä¸é™·é˜±](#52-é—­åŒ…æ”¯æŒçš„åŸç†ä¸é™·é˜±)
  - [5.3 ä¸ compute çš„è¯¦ç»†å¯¹æ¯”](#53-ä¸-compute-çš„è¯¦ç»†å¯¹æ¯”)
  - [5.4 å®æˆ˜ä»£ç ç¤ºä¾‹](#54-å®æˆ˜ä»£ç ç¤ºä¾‹)
  - [5.5 å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ](#55-å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ)
  - [5.6 æœ€ä½³å®è·µä¸é€‰å‹å»ºè®®](#56-æœ€ä½³å®è·µä¸é€‰å‹å»ºè®®)

- [å…­ã€Platform Channels + åŸç”Ÿçº¿ç¨‹æ·±åº¦è¯¦è§£](#å…­platform-channels--åŸç”Ÿçº¿ç¨‹æ·±åº¦è¯¦è§£)
  - [6.1 ä¸ºä»€ä¹ˆéœ€è¦åŸç”Ÿçº¿ç¨‹ï¼Ÿ](#61-ä¸ºä»€ä¹ˆéœ€è¦åŸç”Ÿçº¿ç¨‹)
  - [6.2 Platform Channels æœºåˆ¶æ·±åº¦è§£æ](#62-platform-channels-æœºåˆ¶æ·±åº¦è§£æ)
  - [6.3 Android åŸç”Ÿçº¿ç¨‹å®ç°è¯¦è§£](#63-android-åŸç”Ÿçº¿ç¨‹å®ç°è¯¦è§£)
  - [6.4 iOS åŸç”Ÿçº¿ç¨‹å®ç°è¯¦è§£](#64-ios-åŸç”Ÿçº¿ç¨‹å®ç°è¯¦è§£)
  - [6.5 æ€§èƒ½ä¸ç»´æŠ¤æˆæœ¬åˆ†æ](#65-æ€§èƒ½ä¸ç»´æŠ¤æˆæœ¬åˆ†æ)
  - [6.6 å®æˆ˜åœºæ™¯ç¤ºä¾‹](#66-å®æˆ˜åœºæ™¯ç¤ºä¾‹)
  - [6.7 æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹](#67-æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹)

- [ä¸ƒã€æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹æŒ‡å—](#ä¸ƒæ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹æŒ‡å—)
  - [7.1 å››å¤§æ–¹æ¡ˆç‰¹æ€§å¯¹æ¯”è¡¨](#71-å››å¤§æ–¹æ¡ˆç‰¹æ€§å¯¹æ¯”è¡¨)
  - [7.2 æ€§èƒ½åŸºå‡†æµ‹è¯•](#72-æ€§èƒ½åŸºå‡†æµ‹è¯•)
  - [7.3 é€‰å‹å†³ç­–æ ‘](#73-é€‰å‹å†³ç­–æ ‘)
  - [7.4 åœºæ™¯æ¨èçŸ©é˜µ](#74-åœºæ™¯æ¨èçŸ©é˜µ)
  - [7.5 ä¸åŸç”Ÿå¹³å°å¯¹æ¯”](#75-ä¸åŸç”Ÿå¹³å°å¯¹æ¯”)

- [å…«ã€å®é™…åº”ç”¨åœºæ™¯æ·±åº¦è¯¦è§£](#å…«å®é™…åº”ç”¨åœºæ™¯æ·±åº¦è¯¦è§£)
  - [8.1 å›¾ç‰‡å¤„ç†åœºæ™¯](#81-å›¾ç‰‡å¤„ç†åœºæ™¯)
  - [8.2 å¤§æ•°æ®è§£æåœºæ™¯](#82-å¤§æ•°æ®è§£æåœºæ™¯)
  - [8.3 æ•°æ®åº“æ“ä½œåœºæ™¯](#83-æ•°æ®åº“æ“ä½œåœºæ™¯)
  - [8.4 æ–‡ä»¶å‹ç¼©ä¸è§£å‹åœºæ™¯](#84-æ–‡ä»¶å‹ç¼©ä¸è§£å‹åœºæ™¯)
  - [8.5 åŠ å¯†è§£å¯†è¿ç®—åœºæ™¯](#85-åŠ å¯†è§£å¯†è¿ç®—åœºæ™¯)
  - [8.6 ç½‘ç»œè¯·æ±‚åœºæ™¯](#86-ç½‘ç»œè¯·æ±‚åœºæ™¯)

- [ä¹ã€æœ€ä½³å®è·µä¸å¸¸è§é™·é˜±æ·±åº¦è§£æ](#ä¹æœ€ä½³å®è·µä¸å¸¸è§é™·é˜±æ·±åº¦è§£æ)
  - [9.1 ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ€ä½³å®è·µ](#91-ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ€ä½³å®è·µ)
  - [9.2 å†…å­˜æ³„æ¼é˜²æ­¢](#92-å†…å­˜æ³„æ¼é˜²æ­¢)
  - [9.3 çº¿ç¨‹å®‰å…¨ä¸æ•°æ®å…±äº«](#93-çº¿ç¨‹å®‰å…¨ä¸æ•°æ®å…±äº«)
  - [9.4 é”™è¯¯å¤„ç†ç­–ç•¥](#94-é”™è¯¯å¤„ç†ç­–ç•¥)
  - [9.5 æ€§èƒ½è°ƒä¼˜æŠ€å·§](#95-æ€§èƒ½è°ƒä¼˜æŠ€å·§)
  - [9.6 è°ƒè¯•æ–¹æ³•ä¸å·¥å…·](#96-è°ƒè¯•æ–¹æ³•ä¸å·¥å…·)
  - [9.7 å¸¸è§é”™è¯¯ä¸è§£å†³æ–¹æ¡ˆ](#97-å¸¸è§é”™è¯¯ä¸è§£å†³æ–¹æ¡ˆ)
  - [9.8 è·¨å¹³å°å·®å¼‚æ³¨æ„äº‹é¡¹](#98-è·¨å¹³å°å·®å¼‚æ³¨æ„äº‹é¡¹)

- [åã€é™„å½•](#åé™„å½•)
  - [10.1 API é€ŸæŸ¥è¡¨](#101-api-é€ŸæŸ¥è¡¨)
  - [10.2 ä¸åŸç”Ÿå¹³å°å¯¹æ¯”è¡¨](#102-ä¸åŸç”Ÿå¹³å°å¯¹æ¯”è¡¨)
  - [10.3 æ€§èƒ½åŸºå‡†æ•°æ®æ±‡æ€»](#103-æ€§èƒ½åŸºå‡†æ•°æ®æ±‡æ€»)
  - [10.4 å‚è€ƒèµ„æ–™](#104-å‚è€ƒèµ„æ–™)
  - [10.5 æœ€ä½³å®è·µæ¸…å•](#105-æœ€ä½³å®è·µæ¸…å•)

---

## ä¸€ã€å¼•è¨€

### 1.1 æ–‡æ¡£ç›®æ ‡ä¸è¯»è€…å®šä½

æœ¬æ–‡æ¡£é¢å‘**ä¸­çº§ Flutter å¼€å‘è€…**ï¼Œæ—¨åœ¨å¸®åŠ©æ‚¨æ·±å…¥ç†è§£ Flutter å¤šçº¿ç¨‹ç¼–ç¨‹çš„åŸç†ã€æƒè¡¡å’Œæœ€ä½³å®è·µã€‚

**æ‚¨å°†å­¦åˆ°ï¼š**
- ä¸ä»…æ˜¯"æ€ä¹ˆåš"ï¼Œæ›´é‡è¦çš„æ˜¯"ä¸ºä»€ä¹ˆè¿™æ ·åš"ã€"ä»€ä¹ˆæ—¶å€™ç”¨"ã€"æœ‰ä»€ä¹ˆé£é™©"
- 4 ç§ä¸»è¦å¤šçº¿ç¨‹æ–¹æ¡ˆçš„åº•å±‚åŸç†å’Œå·¥ä½œæœºåˆ¶
- åŸºäºçœŸå®é¡¹ç›®åœºæ™¯çš„å®Œæ•´ä»£ç ç¤ºä¾‹
- å¸¸è§é”™è¯¯å’Œæ­£ç¡®åšæ³•çš„å¯¹æ¯”ï¼Œå¸®åŠ©æ‚¨é¿å¼€é™·é˜±
- æ€§èƒ½æµ‹è¯•æ•°æ®å’Œé€‰å‹å†³ç­–å·¥å…·

**å‰ç½®çŸ¥è¯†è¦æ±‚ï¼š**
- ç†Ÿæ‚‰ Flutter åŸºç¡€å¼€å‘
- äº†è§£ Dart è¯­è¨€çš„åŸºæœ¬è¯­æ³•
- ç†è§£å¼‚æ­¥ç¼–ç¨‹ï¼ˆasync/awaitã€Futureã€Streamï¼‰çš„åŸºæœ¬æ¦‚å¿µ

### 1.2 Flutter å¹¶å‘ç¼–ç¨‹çš„æŒ‘æˆ˜ä¸ç—›ç‚¹

åœ¨ Flutter å¼€å‘ä¸­ï¼Œæ‚¨å¯èƒ½é‡åˆ°è¿‡ä»¥ä¸‹é—®é¢˜ï¼š

**é—®é¢˜ 1ï¼šUI å¡é¡¿**
```dart
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šåœ¨ä¸»çº¿ç¨‹è¿›è¡Œè€—æ—¶æ“ä½œ
void loadData() {
  // è§£æ 10MB çš„ JSON æ•°æ®
  final data = jsonDecode(largeJsonString); // UI ä¼šå¡é¡¿æ•°ç§’
  setState(() {
    this.data = data;
  });
}
```

å½“æ‚¨åœ¨ä¸»çº¿ç¨‹ï¼ˆUI çº¿ç¨‹ï¼‰æ‰§è¡Œè€—æ—¶æ“ä½œæ—¶ï¼ŒFlutter æ— æ³•åŠæ—¶æ¸²æŸ“ä¸‹ä¸€å¸§ï¼Œå¯¼è‡´ç•Œé¢å¡é¡¿ã€ç”¨æˆ·ä½“éªŒä¸‹é™ã€‚

**é—®é¢˜ 2ï¼šä¸çŸ¥é“ä½•æ—¶ä½¿ç”¨å¤šçº¿ç¨‹**
- `async/await` èƒ½è§£å†³é—®é¢˜å—ï¼Ÿ
- ä»€ä¹ˆæ—¶å€™éœ€è¦ `Isolate`ï¼Ÿ
- `compute` å’Œ `Isolate.spawn` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
- æ˜¯å¦éœ€è¦è°ƒç”¨åŸç”Ÿçº¿ç¨‹ï¼Ÿ

**é—®é¢˜ 3ï¼šå¤šçº¿ç¨‹å®ç°å¤æ‚**
- `Isolate` çš„é€šä¿¡æœºåˆ¶éš¾ä»¥ç†è§£
- æ•°æ®åºåˆ—åŒ–é™åˆ¶è®©äººå›°æƒ‘
- èµ„æºç®¡ç†å’Œå†…å­˜æ³„æ¼é—®é¢˜
- é”™è¯¯å¤„ç†å’Œè°ƒè¯•å›°éš¾

**é—®é¢˜ 4ï¼šæ€§èƒ½æƒè¡¡ä¸æ¸…æ™°**
- åˆ›å»º `Isolate` çš„å¼€é”€æœ‰å¤šå¤§ï¼Ÿ
- ä»€ä¹ˆæ ·çš„ä»»åŠ¡å€¼å¾—ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ
- å¦‚ä½•æµ‹è¯•å’Œä¼˜åŒ–æ€§èƒ½ï¼Ÿ

æœ¬æ–‡æ¡£å°†ç³»ç»Ÿæ€§åœ°è§£å†³è¿™äº›é—®é¢˜ï¼Œå¸®åŠ©æ‚¨å»ºç«‹å¯¹ Flutter å¤šçº¿ç¨‹ç¼–ç¨‹çš„æ·±åº¦ç†è§£ã€‚

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦å¤šçº¿ç¨‹ï¼Ÿ

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªçœŸå®åœºæ™¯æ¥ç†è§£å¤šçº¿ç¨‹çš„å¿…è¦æ€§ã€‚

**åœºæ™¯ï¼šå›¾ç‰‡å¤„ç†åº”ç”¨**

å‡è®¾æ‚¨æ­£åœ¨å¼€å‘ä¸€ä¸ªå›¾ç‰‡ç¼–è¾‘åº”ç”¨ï¼Œç”¨æˆ·ä¸Šä¼ äº†ä¸€å¼  4000Ã—3000 åƒç´ çš„ç…§ç‰‡ï¼Œéœ€è¦åº”ç”¨æ»¤é•œæ•ˆæœã€‚

```dart
// âŒ é”™è¯¯åšæ³•ï¼šåœ¨ä¸»çº¿ç¨‹å¤„ç†
void applyFilter(Uint8List imageData) {
  // éå† 1200 ä¸‡ä¸ªåƒç´ ç‚¹ï¼Œæ¯ä¸ªåƒç´ è¿›è¡Œå¤æ‚è®¡ç®—
  for (int i = 0; i < imageData.length; i += 4) {
    // åº”ç”¨æ»¤é•œç®—æ³•...
    imageData[i] = complexCalculation(imageData[i]);     // R
    imageData[i+1] = complexCalculation(imageData[i+1]); // G
    imageData[i+2] = complexCalculation(imageData[i+2]); // B
  }
  setState(() {
    processedImage = imageData;
  });
}
```

**é—®é¢˜åˆ†æï¼š**
- å¤„ç† 1200 ä¸‡ä¸ªåƒç´ å¯èƒ½éœ€è¦ 2-5 ç§’
- åœ¨è¿™æœŸé—´ï¼ŒUI å®Œå…¨å†»ç»“
- ç”¨æˆ·æ— æ³•æ»šåŠ¨ã€ç‚¹å‡»æˆ–æ‰§è¡Œä»»ä½•æ“ä½œ
- åº”ç”¨çœ‹èµ·æ¥åƒ"å´©æºƒ"äº†

**Flutter çš„ 16ms æ¸²æŸ“å‘¨æœŸé™åˆ¶ï¼š**

Flutter éœ€è¦åœ¨æ¯ 16msï¼ˆ60 FPSï¼‰å†…å®Œæˆä¸€å¸§çš„æ¸²æŸ“ã€‚å¦‚æœä¸»çº¿ç¨‹è¢«é˜»å¡è¶…è¿‡ 16msï¼Œå°±ä¼šå‡ºç°ä¸¢å¸§å’Œå¡é¡¿ã€‚

```
æ—¶é—´çº¿ï¼š
0ms    16ms   32ms   48ms   64ms   80ms
 |------|------|------|------|------|
 å¸§1    å¸§2    å¸§3    å¸§4    å¸§5    å¸§6
        â†‘
        å¦‚æœè¿™é‡Œè¢«é˜»å¡è¶…è¿‡ 16msï¼Œç”¨æˆ·ä¼šæ„Ÿè§‰åˆ°å¡é¡¿
```

**å¤šçº¿ç¨‹è§£å†³æ–¹æ¡ˆï¼š**

ä½¿ç”¨ `Isolate` æˆ– `compute` å°†è€—æ—¶æ“ä½œç§»åˆ°åå°çº¿ç¨‹ï¼š

```dart
// âœ… æ­£ç¡®åšæ³•ï¼šä½¿ç”¨ compute åœ¨åå°å¤„ç†
Future<void> applyFilterAsync(Uint8List imageData) async {
  // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
  setState(() => isProcessing = true);

  // åœ¨åå° Isolate ä¸­å¤„ç†å›¾ç‰‡
  final processed = await compute(applyFilterInBackground, imageData);

  // æ›´æ–° UI
  setState(() {
    processedImage = processed;
    isProcessing = false;
  });
}

// è¿™ä¸ªå‡½æ•°åœ¨ç‹¬ç«‹çš„ Isolate ä¸­è¿è¡Œ
Uint8List applyFilterInBackground(Uint8List imageData) {
  for (int i = 0; i < imageData.length; i += 4) {
    imageData[i] = complexCalculation(imageData[i]);
    imageData[i+1] = complexCalculation(imageData[i+1]);
    imageData[i+2] = complexCalculation(imageData[i+2]);
  }
  return imageData;
}
```

**æ•ˆæœå¯¹æ¯”ï¼š**

| æ–¹æ¡ˆ | UI å“åº”æ€§ | ç”¨æˆ·ä½“éªŒ | å®ç°å¤æ‚åº¦ |
|------|----------|---------|-----------|
| ä¸»çº¿ç¨‹å¤„ç† | âŒ å®Œå…¨å†»ç»“ | âŒ å¾ˆå·® | âœ… ç®€å• |
| å¤šçº¿ç¨‹å¤„ç† | âœ… æµç•… | âœ… ä¼˜ç§€ | âš ï¸ ä¸­ç­‰ |

### 1.4 æ–‡æ¡£ç»“æ„å¯¼è§ˆ

æœ¬æ–‡æ¡£æŒ‰ç…§"ä»åŸºç¡€åˆ°é«˜çº§"ã€"ä»åŸç†åˆ°å®è·µ"çš„é¡ºåºç»„ç»‡ï¼š

**ç¬¬äºŒç« ï¼šFlutter å¹¶å‘æ¨¡å‹æ·±åº¦è§£æ**
- ç†è§£ UI çº¿ç¨‹å’Œäº‹ä»¶å¾ªç¯çš„å·¥ä½œåŸç†
- æŒæ¡ Isolate çš„æœ¬è´¨å’Œè®¾è®¡å“²å­¦
- åŒºåˆ†å¼‚æ­¥ï¼ˆasync/awaitï¼‰å’Œå¹¶å‘ï¼ˆIsolateï¼‰
- æ·±å…¥ç†è§£æ¶ˆæ¯ä¼ é€’æœºåˆ¶

**ç¬¬ä¸‰ç« åˆ°ç¬¬å…­ç« ï¼šå››å¤§æ–¹æ¡ˆè¯¦è§£**
- **Isolate åŸç”Ÿ API**ï¼šæœ€çµæ´»ã€æœ€å¼ºå¤§ï¼Œé€‚åˆå¤æ‚åœºæ™¯
- **compute å‡½æ•°**ï¼šæœ€ç®€å•ã€æœ€å¸¸ç”¨ï¼Œé€‚åˆä¸€æ¬¡æ€§ä»»åŠ¡
- **Isolate.run**ï¼šFlutter 3.7+ æ–°ç‰¹æ€§ï¼Œæ›´çµæ´»çš„ API
- **Platform Channels + åŸç”Ÿçº¿ç¨‹**ï¼šæ€§èƒ½æé™åœºæ™¯

æ¯ä¸ªæ–¹æ¡ˆéƒ½åŒ…å«ï¼š
- åº•å±‚åŸç†å’Œå·¥ä½œæœºåˆ¶
- å®Œæ•´çš„å®æˆ˜ä»£ç ç¤ºä¾‹
- å¸¸è§é”™è¯¯ vs æ­£ç¡®åšæ³•å¯¹æ¯”
- æ€§èƒ½åˆ†æå’Œé€‚ç”¨åœºæ™¯

**ç¬¬ä¸ƒç« ï¼šæ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹æŒ‡å—**
- å››å¤§æ–¹æ¡ˆçš„ç‰¹æ€§å¯¹æ¯”è¡¨
- æ€§èƒ½åŸºå‡†æµ‹è¯•æ•°æ®
- é€‰å‹å†³ç­–æ ‘
- åœºæ™¯æ¨èçŸ©é˜µ

**ç¬¬å…«ç« ï¼šå®é™…åº”ç”¨åœºæ™¯è¯¦è§£**
- å›¾ç‰‡å¤„ç†ã€æ•°æ®è§£æã€æ•°æ®åº“æ“ä½œ
- æ–‡ä»¶å‹ç¼©ã€åŠ å¯†è§£å¯†ã€ç½‘ç»œè¯·æ±‚
- æ¯ä¸ªåœºæ™¯éƒ½æœ‰å®Œæ•´çš„å®ç°ä»£ç 

**ç¬¬ä¹ç« ï¼šæœ€ä½³å®è·µä¸å¸¸è§é™·é˜±**
- ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€å†…å­˜æ³„æ¼é˜²æ­¢
- çº¿ç¨‹å®‰å…¨ã€é”™è¯¯å¤„ç†ã€æ€§èƒ½è°ƒä¼˜
- è°ƒè¯•æ–¹æ³•å’Œå·¥å…·ä½¿ç”¨

**ç¬¬åç« ï¼šé™„å½•**
- API é€ŸæŸ¥è¡¨
- æ€§èƒ½åŸºå‡†æ•°æ®æ±‡æ€»
- å‚è€ƒèµ„æ–™å’Œæœ€ä½³å®è·µæ¸…å•

ğŸ“Œ **é˜…è¯»å»ºè®®ï¼š**
- å¦‚æœæ‚¨æ˜¯åˆæ¬¡æ¥è§¦ Flutter å¤šçº¿ç¨‹ï¼Œå»ºè®®æŒ‰é¡ºåºé˜…è¯»
- å¦‚æœæ‚¨å·²æœ‰ä¸€å®šç»éªŒï¼Œå¯ä»¥ç›´æ¥è·³åˆ°æ„Ÿå…´è¶£çš„ç« èŠ‚
- æ¯ä¸ªä»£ç ç¤ºä¾‹éƒ½å¯ä»¥ç›´æ¥è¿è¡Œï¼Œå»ºè®®åŠ¨æ‰‹å®è·µ

---

## äºŒã€Flutter å¹¶å‘æ¨¡å‹æ·±åº¦è§£æ

### 2.1 UI çº¿ç¨‹ä¸äº‹ä»¶å¾ªç¯æœºåˆ¶

#### äº‹ä»¶å¾ªç¯çš„å·¥ä½œåŸç†

Flutter çš„ UI çº¿ç¨‹ï¼ˆä¹Ÿç§°ä¸ºä¸»çº¿ç¨‹æˆ– Main Isolateï¼‰åŸºäº**äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰**æ¨¡å‹è¿è¡Œã€‚ç†è§£äº‹ä»¶å¾ªç¯æ˜¯æŒæ¡ Flutter å¤šçº¿ç¨‹çš„åŸºç¡€ã€‚

**äº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒæ¦‚å¿µï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Event Loop (äº‹ä»¶å¾ªç¯)         â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Event Queue (äº‹ä»¶é˜Ÿåˆ—)      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚äº‹ä»¶1â”‚ â”‚äº‹ä»¶2â”‚ â”‚äº‹ä»¶3â”‚ â”‚äº‹ä»¶4â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â†“                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   å¤„ç†äº‹ä»¶ï¼ˆä¸€æ¬¡å¤„ç†ä¸€ä¸ªï¼‰     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â†“                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Microtask Queue (å¾®ä»»åŠ¡é˜Ÿåˆ—)â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº‹ä»¶å¾ªç¯çš„æ‰§è¡Œæµç¨‹ï¼š**

1. **ä»äº‹ä»¶é˜Ÿåˆ—å–å‡ºä¸€ä¸ªäº‹ä»¶**
2. **æ‰§è¡Œè¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°**
3. **å¤„ç†æ‰€æœ‰å¾®ä»»åŠ¡ï¼ˆMicrotasksï¼‰**
4. **æ¸²æŸ“ä¸€å¸§ï¼ˆå¦‚æœéœ€è¦ï¼‰**
5. **é‡å¤æ­¥éª¤ 1-4**

```dart
// äº‹ä»¶å¾ªç¯çš„ç®€åŒ–æ¨¡å‹
void eventLoop() {
  while (true) {
    // 1. å¤„ç†äº‹ä»¶é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªäº‹ä»¶
    if (eventQueue.isNotEmpty) {
      final event = eventQueue.removeFirst();
      event.execute();
    }

    // 2. å¤„ç†æ‰€æœ‰å¾®ä»»åŠ¡
    while (microtaskQueue.isNotEmpty) {
      final microtask = microtaskQueue.removeFirst();
      microtask.execute();
    }

    // 3. æ¸²æŸ“å¸§ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if (needsRendering) {
      renderFrame();
    }
  }
}
```

#### ä¸ºä»€ä¹ˆ UI çº¿ç¨‹ä¼šå¡é¡¿ï¼Ÿ

**å¡é¡¿çš„æ ¹æœ¬åŸå› ï¼š**äº‹ä»¶å¾ªç¯è¢«å•ä¸ªè€—æ—¶ä»»åŠ¡é˜»å¡ï¼Œæ— æ³•åŠæ—¶å¤„ç†å…¶ä»–äº‹ä»¶å’Œæ¸²æŸ“å¸§ã€‚

```dart
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šé˜»å¡äº‹ä»¶å¾ªç¯
void onButtonPressed() {
  // è¿™ä¸ªå¾ªç¯ä¼šé˜»å¡äº‹ä»¶å¾ªç¯ 5 ç§’
  for (int i = 0; i < 5000000000; i++) {
    // å¤æ‚è®¡ç®—...
  }
  print('è®¡ç®—å®Œæˆ');
}

// åœ¨è¿™ 5 ç§’å†…ï¼š
// - ç”¨æˆ·çš„ç‚¹å‡»ã€æ»‘åŠ¨ç­‰æ“ä½œæ— æ³•å“åº”
// - UI æ— æ³•æ¸²æŸ“æ–°çš„å¸§
// - åº”ç”¨çœ‹èµ·æ¥"å¡æ­»"äº†
```

**äº‹ä»¶å¾ªç¯è¢«é˜»å¡çš„æ—¶é—´çº¿ï¼š**

```
æ—¶é—´ï¼š  0ms        2000ms       4000ms       5000ms
       â”‚           â”‚            â”‚            â”‚
äº‹ä»¶ï¼š æŒ‰é’®ç‚¹å‡» â”€â”€â”€â”€â”¤ è®¡ç®—ä¸­... â”€â”€â”¤ è®¡ç®—ä¸­... â”€â”€â”¤ å®Œæˆ
       â”‚           â”‚            â”‚            â”‚
UIï¼š   æ­£å¸¸ â”€â”€â”€â”€â”€â”€â”€â”€â”¤ å†»ç»“ â”€â”€â”€â”€â”€â”€â”€â”¤ å†»ç»“ â”€â”€â”€â”€â”€â”€â”€â”¤ æ¢å¤
       â”‚           â”‚            â”‚            â”‚
ç”¨æˆ·ï¼š ç‚¹å‡» â”€â”€â”€â”€â”€â”€â”€â”€â”¤ ç­‰å¾…... â”€â”€â”€â”€â”¤ ç­‰å¾…... â”€â”€â”€â”€â”¤ çœ‹åˆ°ç»“æœ
```

#### 16ms æ¸²æŸ“å‘¨æœŸçš„é™åˆ¶

Flutter çš„ç›®æ ‡æ˜¯è¾¾åˆ° **60 FPSï¼ˆæ¯ç§’ 60 å¸§ï¼‰**ï¼Œè¿™æ„å‘³ç€æ¯å¸§çš„æ¸²æŸ“æ—¶é—´é¢„ç®—åªæœ‰ **16.67ms**ã€‚

**æ¸²æŸ“æµç¨‹ï¼š**

```
æ¯ä¸€å¸§çš„æ—¶é—´é¢„ç®—ï¼š16.67ms
â”œâ”€ Buildï¼ˆæ„å»º Widget æ ‘ï¼‰ï¼š~2-4ms
â”œâ”€ Layoutï¼ˆå¸ƒå±€è®¡ç®—ï¼‰ï¼š~2-4ms
â”œâ”€ Paintï¼ˆç»˜åˆ¶ï¼‰ï¼š~2-4ms
â”œâ”€ Compositeï¼ˆåˆæˆï¼‰ï¼š~2-4ms
â””â”€ å‰©ä½™æ—¶é—´ï¼š~4-8msï¼ˆç”¨äºå¤„ç†äº‹ä»¶å’Œä¸šåŠ¡é€»è¾‘ï¼‰
```

**âš ï¸ å…³é”®é™åˆ¶ï¼š**

å¦‚æœäº‹ä»¶å¾ªç¯ä¸­çš„ä»»ä½•ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡ 16msï¼Œå°±ä¼šå¯¼è‡´ä¸¢å¸§ï¼š

```dart
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šè¶…è¿‡ 16ms çš„ä»»åŠ¡
void processData() {
  // å‡è®¾è¿™ä¸ªæ“ä½œéœ€è¦ 50ms
  final result = heavyComputation(); // 50ms
  setState(() {
    data = result;
  });
}

// ç»“æœï¼š
// - ä¸¢å¤± 3 å¸§ï¼ˆ50ms / 16.67ms â‰ˆ 3ï¼‰
// - ç”¨æˆ·æ„Ÿè§‰åˆ°æ˜æ˜¾çš„å¡é¡¿
```

**âœ… æ­£ç¡®åšæ³•ï¼š**

å°†è€—æ—¶æ“ä½œç§»åˆ°åå° Isolateï¼š

```dart
// âœ… æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨ compute
Future<void> processDataAsync() async {
  // åœ¨åå° Isolate ä¸­æ‰§è¡Œï¼Œä¸é˜»å¡ UI
  final result = await compute(heavyComputation, inputData);
  setState(() {
    data = result;
  });
}
```

### 2.2 Isolate çš„æœ¬è´¨ä¸è®¾è®¡å“²å­¦

#### ä¸ºä»€ä¹ˆ Dart é€‰æ‹© Isolate è€Œä¸æ˜¯å…±äº«å†…å­˜çº¿ç¨‹ï¼Ÿ

å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€ï¼ˆå¦‚ Javaã€C++ï¼‰ä½¿ç”¨**å…±äº«å†…å­˜çº¿ç¨‹æ¨¡å‹**ï¼Œè€Œ Dart é€‰æ‹©äº†**Isolateï¼ˆéš”ç¦»ï¼‰æ¨¡å‹**ã€‚è¿™æ˜¯ä¸€ä¸ªæ·±æ€ç†Ÿè™‘çš„è®¾è®¡å†³ç­–ã€‚

**å…±äº«å†…å­˜çº¿ç¨‹æ¨¡å‹çš„é—®é¢˜ï¼š**

```java
// Java ç¤ºä¾‹ï¼šå…±äº«å†…å­˜çº¿ç¨‹
class Counter {
    private int count = 0;

    // âŒ çº¿ç¨‹ä¸å®‰å…¨ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¼šå‡ºç°ç«æ€æ¡ä»¶
    public void increment() {
        count++; // è¿™ä¸æ˜¯åŸå­æ“ä½œï¼
    }
}

// éœ€è¦ä½¿ç”¨é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨
class SafeCounter {
    private int count = 0;

    // âœ… ä½¿ç”¨ synchronized ä¿è¯çº¿ç¨‹å®‰å…¨
    public synchronized void increment() {
        count++;
    }
}
```

**å…±äº«å†…å­˜æ¨¡å‹çš„æŒ‘æˆ˜ï¼š**

1. **ç«æ€æ¡ä»¶ï¼ˆRace Conditionsï¼‰**ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«æ•°æ®
2. **æ­»é”ï¼ˆDeadlocksï¼‰**ï¼šçº¿ç¨‹ç›¸äº’ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”
3. **æ•°æ®ä¸ä¸€è‡´**ï¼šç¼“å­˜ä¸€è‡´æ€§é—®é¢˜
4. **è°ƒè¯•å›°éš¾**ï¼šå¹¶å‘ bug éš¾ä»¥é‡ç°å’Œè°ƒè¯•
5. **æ€§èƒ½å¼€é”€**ï¼šé¢‘ç¹çš„é”æ“ä½œå½±å“æ€§èƒ½

**Dart çš„ Isolate æ¨¡å‹ï¼š**

Dart é€‰æ‹©äº†**å®Œå…¨éš”ç¦»**çš„å¹¶å‘æ¨¡å‹ï¼Œæ¯ä¸ª Isolate æ‹¥æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Main Isolate      â”‚     â”‚   Worker Isolate    â”‚
â”‚                     â”‚     â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Memory Heap  â”‚  â”‚     â”‚  â”‚  Memory Heap  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Object Aâ”‚  â”‚  â”‚     â”‚  â”‚  â”‚ Object Bâ”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â†•           â”‚     â”‚         â†•           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Event Loop   â”‚  â”‚     â”‚  â”‚  Event Loop   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†•                           â†•
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ¶ˆæ¯ä¼ é€’ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              (SendPort/ReceivePort)
```

**Isolate æ¨¡å‹çš„ä¼˜åŠ¿ï¼š**

1. **æ— éœ€é”**ï¼šæ¯ä¸ª Isolate ç‹¬ç«‹è¿è¡Œï¼Œä¸å­˜åœ¨å…±äº«å†…å­˜
2. **æ— ç«æ€æ¡ä»¶**ï¼šæ•°æ®éš”ç¦»ï¼Œä¸ä¼šå‡ºç°å¹¶å‘è®¿é—®é—®é¢˜
3. **æ˜“äºæ¨ç†**ï¼šä»£ç é€»è¾‘æ›´æ¸…æ™°ï¼Œæ›´å®¹æ˜“ç†è§£
4. **æ›´å®‰å…¨**ï¼šé¿å…äº†å¤§é‡å¹¶å‘ç¼–ç¨‹çš„é™·é˜±
5. **æ›´å¥½çš„æ€§èƒ½**ï¼šæ— é”è®¾è®¡ï¼Œå‡å°‘äº†åŒæ­¥å¼€é”€

**ä»£ä»·ï¼š**

1. **é€šä¿¡å¼€é”€**ï¼šéœ€è¦é€šè¿‡æ¶ˆæ¯ä¼ é€’è¿›è¡Œé€šä¿¡
2. **æ•°æ®åºåˆ—åŒ–**ï¼šä¼ é€’çš„æ•°æ®éœ€è¦åºåˆ—åŒ–å’Œååºåˆ—åŒ–
3. **å†…å­˜å¼€é”€**ï¼šæ¯ä¸ª Isolate æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´

#### Isolate vs Thread çš„æ ¹æœ¬åŒºåˆ«

| ç‰¹æ€§ | ä¼ ç»Ÿçº¿ç¨‹ï¼ˆThreadï¼‰ | Dart Isolate |
|------|------------------|--------------|
| å†…å­˜æ¨¡å‹ | å…±äº«å†…å­˜ | å®Œå…¨éš”ç¦» |
| æ•°æ®è®¿é—® | ç›´æ¥è®¿é—®å…±äº«æ•°æ® | é€šè¿‡æ¶ˆæ¯ä¼ é€’ |
| åŒæ­¥æœºåˆ¶ | éœ€è¦é”ï¼ˆLockã€Mutexï¼‰ | æ— éœ€é” |
| ç«æ€æ¡ä»¶ | å¯èƒ½å‘ç”Ÿ | ä¸ä¼šå‘ç”Ÿ |
| æ­»é”é£é™© | å­˜åœ¨ | ä¸å­˜åœ¨ |
| é€šä¿¡æ–¹å¼ | å…±äº«å†…å­˜ | SendPort/ReceivePort |
| è°ƒè¯•éš¾åº¦ | å›°éš¾ | ç›¸å¯¹å®¹æ˜“ |
| æ€§èƒ½å¼€é”€ | é”ç«äº‰å¼€é”€ | æ¶ˆæ¯ä¼ é€’å¼€é”€ |

### 2.3 å¼‚æ­¥ï¼ˆasync/awaitï¼‰vs å¹¶å‘ï¼ˆIsolateï¼‰

è¿™æ˜¯ Flutter å¼€å‘ä¸­æœ€å®¹æ˜“æ··æ·†çš„æ¦‚å¿µä¹‹ä¸€ã€‚è®©æˆ‘ä»¬æ·±å…¥ç†è§£å®ƒä»¬çš„æœ¬è´¨åŒºåˆ«ã€‚

#### ä¸¤è€…çš„æœ¬è´¨åŒºåˆ«

**å¼‚æ­¥ï¼ˆasync/awaitï¼‰ï¼š**
- åœ¨**åŒä¸€ä¸ªçº¿ç¨‹**ï¼ˆåŒä¸€ä¸ª Isolateï¼‰ä¸­æ‰§è¡Œ
- ä¸ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹æˆ– Isolate
- é€šè¿‡äº‹ä»¶å¾ªç¯è°ƒåº¦ä»»åŠ¡
- é€‚åˆ I/O å¯†é›†å‹æ“ä½œï¼ˆç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™ï¼‰

**å¹¶å‘ï¼ˆIsolateï¼‰ï¼š**
- åœ¨**ä¸åŒçš„çº¿ç¨‹**ï¼ˆä¸åŒçš„ Isolateï¼‰ä¸­æ‰§è¡Œ
- åˆ›å»ºæ–°çš„ç‹¬ç«‹æ‰§è¡Œç¯å¢ƒ
- çœŸæ­£çš„å¹¶è¡Œæ‰§è¡Œ
- é€‚åˆ CPU å¯†é›†å‹æ“ä½œï¼ˆå¤æ‚è®¡ç®—ã€å›¾ç‰‡å¤„ç†ï¼‰

#### ä½•æ—¶ç”¨å¼‚æ­¥ï¼Ÿä½•æ—¶ç”¨å¹¶å‘ï¼Ÿ

**ä½¿ç”¨ async/await çš„åœºæ™¯ï¼š**

```dart
// âœ… é€‚åˆä½¿ç”¨ async/awaitï¼šç½‘ç»œè¯·æ±‚
Future<User> fetchUser(String userId) async {
  // ç­‰å¾…ç½‘ç»œå“åº”ï¼Œä½†ä¸é˜»å¡ UI çº¿ç¨‹
  final response = await http.get('https://api.example.com/users/$userId');
  return User.fromJson(jsonDecode(response.body));
}

// âœ… é€‚åˆä½¿ç”¨ async/awaitï¼šæ–‡ä»¶è¯»å–
Future<String> readFile(String path) async {
  // ç­‰å¾…æ–‡ä»¶ I/Oï¼Œä½†ä¸é˜»å¡ UI çº¿ç¨‹
  final file = File(path);
  return await file.readAsString();
}
```

**ä¸ºä»€ä¹ˆ async/await é€‚åˆ I/O æ“ä½œï¼Ÿ**

I/O æ“ä½œçš„å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨**ç­‰å¾…**ï¼ˆç­‰å¾…ç½‘ç»œå“åº”ã€ç­‰å¾…ç£ç›˜è¯»å†™ï¼‰ï¼ŒCPU å®é™…ä¸Šæ˜¯ç©ºé—²çš„ã€‚async/await å…è®¸åœ¨ç­‰å¾…æœŸé—´å¤„ç†å…¶ä»–äº‹ä»¶ï¼Œä¸ä¼šé˜»å¡ UIã€‚

**ä½¿ç”¨ Isolate çš„åœºæ™¯ï¼š**

```dart
// âœ… é€‚åˆä½¿ç”¨ Isolateï¼šCPU å¯†é›†å‹è®¡ç®—
Future<List<int>> sortLargeList(List<int> data) async {
  // åœ¨åå° Isolate ä¸­æ’åºï¼Œé¿å…é˜»å¡ UI
  return await compute(_sortInBackground, data);
}

List<int> _sortInBackground(List<int> data) {
  // è¿™ä¸ªæ“ä½œä¼šæŒç»­å ç”¨ CPU
  data.sort();
  return data;
}

// âœ… é€‚åˆä½¿ç”¨ Isolateï¼šå›¾ç‰‡å¤„ç†
Future<Uint8List> compressImage(Uint8List imageData) async {
  return await compute(_compressInBackground, imageData);
}

Uint8List _compressInBackground(Uint8List data) {
  // CPU å¯†é›†å‹æ“ä½œï¼šéå†æ¯ä¸ªåƒç´ 
  // ...
  return compressedData;
}
```

**ä¸ºä»€ä¹ˆ Isolate é€‚åˆ CPU å¯†é›†å‹æ“ä½œï¼Ÿ**

CPU å¯†é›†å‹æ“ä½œä¼š**æŒç»­å ç”¨** CPUï¼Œå¦‚æœåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œä¼šé˜»å¡äº‹ä»¶å¾ªç¯ã€‚Isolate åœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¸ä¼šå½±å“ UI å“åº”ã€‚

#### å¸¸è§è¯¯åŒºï¼šå¼‚æ­¥ä¸ç­‰äºå¤šçº¿ç¨‹

**âŒ é”™è¯¯ç†è§£ï¼š**

```dart
// è¿™æ®µä»£ç ä»ç„¶ä¼šé˜»å¡ UIï¼
Future<void> processData() async {
  // è™½ç„¶ä½¿ç”¨äº† asyncï¼Œä½†è¿™ä¸ªå¾ªç¯ä»åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ
  for (int i = 0; i < 10000000; i++) {
    // å¤æ‚è®¡ç®—...
  }
  print('å®Œæˆ');
}
```

**ä¸ºä»€ä¹ˆä¼šé˜»å¡ï¼Ÿ**

`async` å…³é”®å­—åªæ˜¯è®©å‡½æ•°è¿”å› `Future`ï¼Œå¹¶ä¸ä¼šè‡ªåŠ¨å°†ä»£ç ç§»åˆ°åå°çº¿ç¨‹ã€‚ä¸Šé¢çš„å¾ªç¯ä»ç„¶åœ¨ä¸»çº¿ç¨‹ï¼ˆMain Isolateï¼‰ä¸­æ‰§è¡Œï¼Œä¼šé˜»å¡ UIã€‚

**âœ… æ­£ç¡®åšæ³•ï¼š**

```dart
// ä½¿ç”¨ compute å°†è®¡ç®—ç§»åˆ°åå° Isolate
Future<void> processDataCorrectly() async {
  await compute(_heavyComputation, null);
  print('å®Œæˆ');
}

void _heavyComputation(dynamic _) {
  for (int i = 0; i < 10000000; i++) {
    // å¤æ‚è®¡ç®—...
  }
}
```

**å†³ç­–æµç¨‹å›¾ï¼š**

```
éœ€è¦æ‰§è¡Œè€—æ—¶æ“ä½œï¼Ÿ
    â”‚
    â”œâ”€ æ˜¯ I/O æ“ä½œï¼ˆç½‘ç»œã€æ–‡ä»¶ã€æ•°æ®åº“ï¼‰ï¼Ÿ
    â”‚   â””â”€ æ˜¯ â†’ ä½¿ç”¨ async/await
    â”‚
    â””â”€ æ˜¯ CPU å¯†é›†å‹æ“ä½œï¼ˆè®¡ç®—ã€å›¾ç‰‡å¤„ç†ï¼‰ï¼Ÿ
        â”‚
        â”œâ”€ æ‰§è¡Œæ—¶é—´ < 16msï¼Ÿ
        â”‚   â””â”€ æ˜¯ â†’ å¯ä»¥åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ
        â”‚
        â””â”€ æ‰§è¡Œæ—¶é—´ > 16msï¼Ÿ
            â””â”€ æ˜¯ â†’ ä½¿ç”¨ Isolateï¼ˆcompute æˆ– Isolate.spawnï¼‰
```

### 2.4 æ¶ˆæ¯ä¼ é€’æœºåˆ¶æ·±åº¦è§£æ

#### SendPort/ReceivePort çš„å·¥ä½œåŸç†

Isolate ä¹‹é—´é€šè¿‡ **SendPort** å’Œ **ReceivePort** è¿›è¡Œé€šä¿¡ã€‚ç†è§£è¿™ä¸ªæœºåˆ¶æ˜¯æŒæ¡ Isolate çš„å…³é”®ã€‚

**åŸºæœ¬æ¦‚å¿µï¼š**

```dart
// ReceivePortï¼šæ¥æ”¶æ¶ˆæ¯çš„ç«¯å£
final receivePort = ReceivePort();

// SendPortï¼šå‘é€æ¶ˆæ¯çš„ç«¯å£
final sendPort = receivePort.sendPort;

// ç›‘å¬æ¶ˆæ¯
receivePort.listen((message) {
  print('æ”¶åˆ°æ¶ˆæ¯ï¼š$message');
});

// å‘é€æ¶ˆæ¯
sendPort.send('Hello');
```

**é€šä¿¡æµç¨‹ï¼š**

```
Main Isolate                    Worker Isolate
     â”‚                               â”‚
     â”‚  1. åˆ›å»º ReceivePort           â”‚
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
     â”‚  â”‚ ReceivePort â”‚              â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
     â”‚         â”‚                     â”‚
     â”‚  2. è·å– SendPort              â”‚
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
     â”‚  â”‚  SendPort   â”‚              â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
     â”‚         â”‚                     â”‚
     â”‚  3. å¯åŠ¨ Worker Isolate        â”‚
     â”‚         â”‚                     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚         â”‚                     â”‚
     â”‚  4. ä¼ é€’ SendPort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                               â”‚
     â”‚  5. Worker åˆ›å»ºè‡ªå·±çš„ ReceivePort
     â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                         â”‚ ReceivePort â”‚
     â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                               â”‚
     â”‚  6. Worker å‘é€è‡ªå·±çš„ SendPort â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                               â”‚
     â”‚  7. åŒå‘é€šä¿¡å»ºç«‹å®Œæˆ           â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
```

**å®Œæ•´ç¤ºä¾‹ï¼š**

```dart
import 'dart:isolate';

// ä¸» Isolate
Future<void> main() async {
  // 1. åˆ›å»ºæ¥æ”¶ç«¯å£
  final receivePort = ReceivePort();

  // 2. å¯åŠ¨ Worker Isolateï¼Œä¼ é€’ SendPort
  await Isolate.spawn(workerIsolate, receivePort.sendPort);

  // 3. ç­‰å¾… Worker å‘é€å®ƒçš„ SendPort
  final workerSendPort = await receivePort.first as SendPort;

  // 4. ç°åœ¨å¯ä»¥å‘ Worker å‘é€æ¶ˆæ¯
  workerSendPort.send('Hello from Main');

  // 5. æ¥æ”¶ Worker çš„å“åº”
  receivePort.listen((message) {
    print('Main æ”¶åˆ°ï¼š$message');
  });
}

// Worker Isolate
void workerIsolate(SendPort mainSendPort) {
  // 1. åˆ›å»ºè‡ªå·±çš„æ¥æ”¶ç«¯å£
  final workerReceivePort = ReceivePort();

  // 2. å°†è‡ªå·±çš„ SendPort å‘é€ç»™ Main
  mainSendPort.send(workerReceivePort.sendPort);

  // 3. ç›‘å¬æ¥è‡ª Main çš„æ¶ˆæ¯
  workerReceivePort.listen((message) {
    print('Worker æ”¶åˆ°ï¼š$message');

    // 4. å‘é€å“åº”
    mainSendPort.send('Hello from Worker');
  });
}
```

#### æ¶ˆæ¯åºåˆ—åŒ–çš„æ€§èƒ½æˆæœ¬

**å¯ä¼ é€’çš„æ•°æ®ç±»å‹ï¼š**

Isolate ä¹‹é—´ä¼ é€’çš„æ•°æ®å¿…é¡»æ˜¯**å¯åºåˆ—åŒ–**çš„ã€‚ä»¥ä¸‹ç±»å‹å¯ä»¥ç›´æ¥ä¼ é€’ï¼š

- åŸºæœ¬ç±»å‹ï¼š`int`ã€`double`ã€`bool`ã€`String`ã€`null`
- é›†åˆç±»å‹ï¼š`List`ã€`Map`ã€`Set`ï¼ˆå…ƒç´ ä¹Ÿå¿…é¡»å¯åºåˆ—åŒ–ï¼‰
- `Uint8List`ã€`Int32List` ç­‰ TypedData
- `SendPort`

**ä¸å¯ä¼ é€’çš„æ•°æ®ç±»å‹ï¼š**

- å‡½æ•°å’Œé—­åŒ…
- `Socket`ã€`File` ç­‰ I/O å¯¹è±¡
- `BuildContext`ã€`Widget` ç­‰ Flutter UI å¯¹è±¡
- åŒ…å«ä¸å¯åºåˆ—åŒ–å­—æ®µçš„è‡ªå®šä¹‰ç±»

**æ€§èƒ½æˆæœ¬åˆ†æï¼š**

```dart
// ç¤ºä¾‹ï¼šä¼ é€’å¤§å‹æ•°æ®çš„æ€§èƒ½æˆæœ¬
class ImageData {
  final Uint8List pixels; // 4000Ã—3000Ã—4 = 48MB
  final int width;
  final int height;

  ImageData(this.pixels, this.width, this.height);
}

// âŒ é”™è¯¯ï¼šä¼ é€’å¤§å¯¹è±¡ä¼šæœ‰åºåˆ—åŒ–å¼€é”€
Future<void> processImage(ImageData data) async {
  // åºåˆ—åŒ– 48MB æ•°æ®å¯èƒ½éœ€è¦ 50-100ms
  await compute(_process, data);
}

// âœ… ä¼˜åŒ–ï¼šç›´æ¥ä¼ é€’ Uint8Listï¼ˆé¿å…é¢å¤–åºåˆ—åŒ–ï¼‰
Future<void> processImageOptimized(Uint8List pixels) async {
  // Uint8List æ¯”è‡ªå®šä¹‰ç±»æ›´é«˜æ•ˆï¼Œä½† compute ä»ä¼šå¤åˆ¶æ•°æ®
  await compute(_processPixels, pixels);
}

// âœ… çœŸæ­£é›¶æ‹·è´ï¼šä½¿ç”¨ TransferableTypedDataï¼ˆDart 2.15+ï¼‰
Future<void> processImageZeroCopy(Uint8List pixels) async {
  final transferable = TransferableTypedData.fromList([pixels]);
  final receivePort = ReceivePort();

  await Isolate.spawn(_processTransferable, {
    'data': transferable,
    'sendPort': receivePort.sendPort,
  });

  await receivePort.first;
  receivePort.close();
}

void _processTransferable(Map<String, dynamic> message) {
  final transferable = message['data'] as TransferableTypedData;
  final sendPort = message['sendPort'] as SendPort;

  // materialize() å°†æ•°æ®"ç‰©åŒ–"åˆ°å½“å‰ Isolate
  final byteData = transferable.materialize();
  final pixels = byteData.buffer.asUint8List();

  // å¤„ç†å›¾ç‰‡æ•°æ®...

  sendPort.send('done');
}
```

**âš ï¸ é‡è¦è¯´æ˜ï¼š**

å¯¹äº `Uint8List`ã€`Int32List` ç­‰ TypedDataï¼Œé€šè¿‡æ™®é€š `SendPort`/`compute` ä¼ é€’æ—¶**ä»ä¼šå¤åˆ¶æ•´å—å†…å­˜**ã€‚åªæœ‰ä½¿ç”¨ `TransferableTypedData` æˆ– `ImmutableBuffer.fromUint8List()` ç­‰ API æ‰èƒ½å®ç°**çœŸæ­£çš„é›¶æ‹·è´ï¼ˆZero-Copyï¼‰**ä¼ é€’ã€‚

**é›¶æ‹·è´çš„ä¼˜åŠ¿ä¸é™åˆ¶ï¼š**
- âœ… é¿å…å†…å­˜å¤åˆ¶ï¼Œæ€§èƒ½æå‡æ˜¾è‘—ï¼ˆå¤§æ•°æ®åœºæ™¯ï¼‰
- âš ï¸ æ•°æ®åªèƒ½"ç§»åŠ¨"ä¸€æ¬¡ï¼ŒåŸ Isolate ä¸åº”ç»§ç»­è®¿é—®
- âš ï¸ éœ€è¦æ‰‹åŠ¨ç®¡ç† `materialize()` è°ƒç”¨

#### å¯ä¼ é€’ vs ä¸å¯ä¼ é€’çš„æ•°æ®ç±»å‹

**å¯ä¼ é€’ç±»å‹ç¤ºä¾‹ï¼š**

```dart
// âœ… å¯ä»¥ä¼ é€’
sendPort.send(42);                          // int
sendPort.send('Hello');                     // String
sendPort.send([1, 2, 3]);                   // List<int>
sendPort.send({'key': 'value'});            // Map<String, String>
sendPort.send(Uint8List(1000));             // TypedData

// âœ… ä¼ é€’è‡ªå®šä¹‰ç±»ï¼šéœ€è¦åºåˆ—åŒ–ä¸º Map
class User {
  final String name;
  final int age;

  User(this.name, this.age);

  // åºåˆ—åŒ–ä¸º Map
  Map<String, dynamic> toJson() => {'name': name, 'age': age};

  // ä» Map ååºåˆ—åŒ–
  factory User.fromJson(Map<String, dynamic> json) {
    return User(json['name'] as String, json['age'] as int);
  }
}

// å‘é€ç«¯ï¼šåºåˆ—åŒ–åå‘é€
final user = User('Alice', 30);
sendPort.send(user.toJson());

// æ¥æ”¶ç«¯ï¼šååºåˆ—åŒ–
receivePort.listen((message) {
  final user = User.fromJson(message as Map<String, dynamic>);
  print('æ”¶åˆ°ç”¨æˆ·ï¼š${user.name}, ${user.age}å²');
});
```

**ä¸å¯ä¼ é€’ç±»å‹ç¤ºä¾‹ï¼š**

```dart
// âŒ ä¸èƒ½ä¼ é€’å‡½æ•°
void myFunction() {}
sendPort.send(myFunction); // é”™è¯¯ï¼

// âŒ ä¸èƒ½ä¼ é€’é—­åŒ…
final x = 10;
sendPort.send(() => x + 1); // é”™è¯¯ï¼

// âŒ ä¸èƒ½ä¼ é€’ UI å¯¹è±¡
sendPort.send(context); // é”™è¯¯ï¼

// âŒ ä¸èƒ½ä¼ é€’åŒ…å«ä¸å¯åºåˆ—åŒ–å­—æ®µçš„ç±»
class MyClass {
  final Function callback; // ä¸å¯åºåˆ—åŒ–
  MyClass(this.callback);
}
sendPort.send(MyClass(() {})); // é”™è¯¯ï¼
```

**è§£å†³æ–¹æ¡ˆï¼š**

å¦‚æœéœ€è¦ä¼ é€’å¤æ‚é€»è¾‘ï¼Œå¯ä»¥ä¼ é€’**æ•°æ®**è€Œä¸æ˜¯**å‡½æ•°**ï¼š

```dart
// âŒ é”™è¯¯ï¼šå°è¯•ä¼ é€’å‡½æ•°
compute(myFunction, data);

// âœ… æ­£ç¡®ï¼šä¼ é€’æ•°æ®ï¼Œåœ¨ Isolate ä¸­å®šä¹‰é€»è¾‘
compute(_processData, data);

static void _processData(Data data) {
  // åœ¨è¿™é‡Œå®šä¹‰å¤„ç†é€»è¾‘
}
```

---

## ä¸‰ã€Isolate åŸç”Ÿ API æ·±åº¦è¯¦è§£

### 3.1 æ ¸å¿ƒ API è¯´æ˜

#### Isolate.spawn() å®Œæ•´å‚æ•°è§£æ

`Isolate.spawn()` æ˜¯åˆ›å»ºæ–° Isolate çš„æ ¸å¿ƒ APIã€‚è®©æˆ‘ä»¬æ·±å…¥ç†è§£å®ƒçš„æ¯ä¸ªå‚æ•°ã€‚

**å‡½æ•°ç­¾åï¼š**

```dart
static Future<Isolate> spawn<T>(
  void Function(T message) entryPoint,  // å…¥å£å‡½æ•°
  T message,                             // ä¼ é€’ç»™å…¥å£å‡½æ•°çš„å‚æ•°
  {
    bool paused = false,                 // æ˜¯å¦æš‚åœå¯åŠ¨
    bool errorsAreFatal = true,          // é”™è¯¯æ˜¯å¦è‡´å‘½
    SendPort? onExit,                    // é€€å‡ºæ—¶çš„å›è°ƒç«¯å£
    SendPort? onError,                   // é”™è¯¯æ—¶çš„å›è°ƒç«¯å£
    String? debugName,                   // è°ƒè¯•åç§°
  }
)
```

**å‚æ•°è¯¦è§£ï¼š**

1. **entryPoint**ï¼šIsolate çš„å…¥å£å‡½æ•°
   - å¿…é¡»æ˜¯é¡¶å±‚å‡½æ•°æˆ–é™æ€æ–¹æ³•
   - ä¸èƒ½æ˜¯å®ä¾‹æ–¹æ³•æˆ–é—­åŒ…
   - æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼ˆé€šè¿‡ `message` ä¼ é€’ï¼‰

2. **message**ï¼šä¼ é€’ç»™å…¥å£å‡½æ•°çš„åˆå§‹æ•°æ®
   - å¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„ç±»å‹
   - é€šå¸¸ä¼ é€’ `SendPort` ç”¨äºåŒå‘é€šä¿¡

3. **paused**ï¼šæ˜¯å¦æš‚åœå¯åŠ¨
   - `true`ï¼šIsolate åˆ›å»ºåæš‚åœï¼Œéœ€è¦æ‰‹åŠ¨æ¢å¤
   - `false`ï¼ˆé»˜è®¤ï¼‰ï¼šç«‹å³å¼€å§‹æ‰§è¡Œ

4. **errorsAreFatal**ï¼šé”™è¯¯å¤„ç†ç­–ç•¥
   - `true`ï¼ˆé»˜è®¤ï¼‰ï¼šæœªæ•è·çš„å¼‚å¸¸ä¼šç»ˆæ­¢ Isolate
   - `false`ï¼šå¼‚å¸¸é€šè¿‡ `onError` ç«¯å£å‘é€

5. **onExit**ï¼šIsolate é€€å‡ºæ—¶çš„é€šçŸ¥
   - ä¼ é€’ä¸€ä¸ª `SendPort`ï¼ŒIsolate é€€å‡ºæ—¶ä¼šå‘é€æ¶ˆæ¯

6. **onError**ï¼šé”™è¯¯é€šçŸ¥ç«¯å£
   - ä¼ é€’ä¸€ä¸ª `SendPort`ï¼Œå‘ç”Ÿé”™è¯¯æ—¶ä¼šå‘é€é”™è¯¯ä¿¡æ¯

7. **debugName**ï¼šè°ƒè¯•åç§°
   - åœ¨ DevTools ä¸­æ˜¾ç¤ºï¼Œä¾¿äºè°ƒè¯•

**åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹ï¼š**

```dart
import 'dart:isolate';

// å…¥å£å‡½æ•°ï¼šå¿…é¡»æ˜¯é¡¶å±‚å‡½æ•°
void isolateEntryPoint(SendPort mainSendPort) {
  print('Worker Isolate å¯åŠ¨');
  mainSendPort.send('Hello from Worker');
}

Future<void> main() async {
  // åˆ›å»ºæ¥æ”¶ç«¯å£
  final receivePort = ReceivePort();

  // å¯åŠ¨ Isolate
  final isolate = await Isolate.spawn(
    isolateEntryPoint,           // å…¥å£å‡½æ•°
    receivePort.sendPort,        // ä¼ é€’ SendPort
    debugName: 'MyWorkerIsolate', // è°ƒè¯•åç§°
  );

  // æ¥æ”¶æ¶ˆæ¯
  receivePort.listen((message) {
    print('Main æ”¶åˆ°ï¼š$message');
  });
}
```

#### ReceivePort/SendPort çš„åˆ›å»ºä¸ä½¿ç”¨

**ReceivePort**ï¼šæ¥æ”¶æ¶ˆæ¯çš„ç«¯å£

```dart
// åˆ›å»º ReceivePort
final receivePort = ReceivePort();

// è·å–å¯¹åº”çš„ SendPort
final sendPort = receivePort.sendPort;

// ç›‘å¬æ¶ˆæ¯
receivePort.listen((message) {
  print('æ”¶åˆ°æ¶ˆæ¯ï¼š$message');
});

// å…³é—­ç«¯å£ï¼ˆé‡è¦ï¼ï¼‰
receivePort.close();
```

**SendPort**ï¼šå‘é€æ¶ˆæ¯çš„ç«¯å£

```dart
// å‘é€æ¶ˆæ¯
sendPort.send('Hello');
sendPort.send(42);
sendPort.send([1, 2, 3]);
sendPort.send({'key': 'value'});
```

**âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹ï¼š**

1. **å¿…é¡»å…³é—­ ReceivePort**ï¼šå¦åˆ™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼
2. **SendPort å¯ä»¥ä¼ é€’**ï¼šå¯ä»¥é€šè¿‡æ¶ˆæ¯ä¼ é€’ SendPort
3. **æ¶ˆæ¯æ˜¯å¼‚æ­¥çš„**ï¼šå‘é€åä¸ä¼šç«‹å³åˆ°è¾¾

#### Isolate.kill() å’Œ Isolate.pause()

**ç»ˆæ­¢ Isolateï¼š**

```dart
// åˆ›å»º Isolate
final isolate = await Isolate.spawn(workerFunction, data);

// ç«‹å³ç»ˆæ­¢
isolate.kill(priority: Isolate.immediate);

// ä¼˜é›…ç»ˆæ­¢ï¼ˆç­‰å¾…å½“å‰ä»»åŠ¡å®Œæˆï¼‰
isolate.kill(priority: Isolate.beforeNextEvent);
```

**æš‚åœå’Œæ¢å¤ Isolateï¼š**

```dart
// æš‚åœ Isolate
final capability = isolate.pause();

// æ¢å¤ Isolate
isolate.resume(capability);
```

### 3.2 åº•å±‚åŸç†ä¸å·¥ä½œæœºåˆ¶

#### Isolate çš„åˆ›å»ºæµç¨‹ï¼ˆä»ç³»ç»Ÿå±‚é¢ï¼‰

å½“æ‚¨è°ƒç”¨ `Isolate.spawn()` æ—¶ï¼ŒDart VM ä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

**åˆ›å»ºæµç¨‹ï¼š**

```
1. åˆ†é…æ–°çš„å†…å­˜å †
   â”œâ”€ åˆ›å»ºç‹¬ç«‹çš„å †ç©ºé—´ï¼ˆHeapï¼‰
   â”œâ”€ åˆå§‹åŒ–åƒåœ¾å›æ”¶å™¨ï¼ˆGCï¼‰
   â””â”€ åˆ†é…åˆå§‹å†…å­˜

2. åˆ›å»ºæ–°çš„çº¿ç¨‹
   â”œâ”€ åœ¨æ“ä½œç³»ç»Ÿå±‚é¢åˆ›å»ºæ–°çº¿ç¨‹
   â”œâ”€ ç»‘å®šåˆ° Dart VM çš„çº¿ç¨‹æ± 
   â””â”€ è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§

3. åˆå§‹åŒ–äº‹ä»¶å¾ªç¯
   â”œâ”€ åˆ›å»ºäº‹ä»¶é˜Ÿåˆ—
   â”œâ”€ åˆ›å»ºå¾®ä»»åŠ¡é˜Ÿåˆ—
   â””â”€ å¯åŠ¨äº‹ä»¶å¾ªç¯

4. å¤åˆ¶å¿…è¦çš„ä»£ç 
   â”œâ”€ å¤åˆ¶å…¥å£å‡½æ•°çš„ä»£ç 
   â”œâ”€ å¤åˆ¶ä¾èµ–çš„åº“ä»£ç 
   â””â”€ å»ºç«‹ä»£ç å¼•ç”¨

5. ä¼ é€’åˆå§‹æ¶ˆæ¯
   â”œâ”€ åºåˆ—åŒ– message å‚æ•°
   â”œâ”€ ä¼ é€’åˆ°æ–° Isolate
   â””â”€ è°ƒç”¨å…¥å£å‡½æ•°

6. å¼€å§‹æ‰§è¡Œ
   â””â”€ å…¥å£å‡½æ•°å¼€å§‹è¿è¡Œ
```

**æ—¶é—´å¼€é”€åˆ†æï¼š**

```dart
// æµ‹é‡ Isolate åˆ›å»ºæ—¶é—´
final stopwatch = Stopwatch()..start();

await Isolate.spawn(workerFunction, data);

stopwatch.stop();
print('åˆ›å»º Isolate è€—æ—¶ï¼š${stopwatch.elapsedMilliseconds}ms');

// å…¸å‹ç»“æœï¼š
// - Android/iOSï¼š10-30ms
// - Desktopï¼š5-15ms
// - Webï¼šä¸æ”¯æŒ Isolate
```

#### æ¶ˆæ¯é˜Ÿåˆ—çš„å®ç°åŸç†

æ¯ä¸ª Isolate éƒ½æœ‰è‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”¨äºæ¥æ”¶æ¥è‡ªå…¶ä»– Isolate çš„æ¶ˆæ¯ã€‚

**æ¶ˆæ¯é˜Ÿåˆ—ç»“æ„ï¼š**

```
Isolate A                          Isolate B
    â”‚                                  â”‚
    â”‚  sendPort.send(msg1)             â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                  â”‚ â”‚ Message Queueâ”‚
    â”‚  sendPort.send(msg2)             â”‚ â”‚  â”Œâ”€â”€â”€â”€â”    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ â”‚  â”‚msg1â”‚    â”‚
    â”‚                                  â”‚ â”‚  â”œâ”€â”€â”€â”€â”¤    â”‚
    â”‚  sendPort.send(msg3)             â”‚ â”‚  â”‚msg2â”‚    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ â”‚  â”œâ”€â”€â”€â”€â”¤    â”‚
    â”‚                                  â”‚ â”‚  â”‚msg3â”‚    â”‚
    â”‚                                  â”‚ â”‚  â””â”€â”€â”€â”€â”˜    â”‚
    â”‚                                  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                  â”‚       â†“
    â”‚                                  â”‚  Event Loop
    â”‚                                  â”‚  å¤„ç†æ¶ˆæ¯
```

**æ¶ˆæ¯å¤„ç†æµç¨‹ï¼š**

1. **å‘é€ç«¯**ï¼šè°ƒç”¨ `sendPort.send(message)`
2. **åºåˆ—åŒ–**ï¼šå°†æ¶ˆæ¯åºåˆ—åŒ–ä¸ºå­—èŠ‚æµ
3. **ä¼ è¾“**ï¼šé€šè¿‡å†…éƒ¨é€šé“ä¼ è¾“åˆ°ç›®æ ‡ Isolate
4. **å…¥é˜Ÿ**ï¼šæ¶ˆæ¯è¿›å…¥ç›®æ ‡ Isolate çš„æ¶ˆæ¯é˜Ÿåˆ—
5. **ååºåˆ—åŒ–**ï¼šä»å­—èŠ‚æµè¿˜åŸä¸ºå¯¹è±¡
6. **å›è°ƒ**ï¼šè§¦å‘ `receivePort.listen()` çš„å›è°ƒå‡½æ•°

#### ä¸ºä»€ä¹ˆå¯åŠ¨ Isolate æœ‰å¼€é”€ï¼Ÿ

**å¼€é”€æ¥æºï¼š**

1. **å†…å­˜åˆ†é…**ï¼ˆ~5-10msï¼‰
   - åˆ†é…æ–°çš„å †ç©ºé—´
   - åˆå§‹åŒ–å†…å­˜ç®¡ç†ç»“æ„

2. **çº¿ç¨‹åˆ›å»º**ï¼ˆ~3-8msï¼‰
   - æ“ä½œç³»ç»Ÿåˆ›å»ºæ–°çº¿ç¨‹
   - çº¿ç¨‹ä¸Šä¸‹æ–‡åˆå§‹åŒ–

3. **ä»£ç å¤åˆ¶**ï¼ˆ~2-5msï¼‰
   - å¤åˆ¶å…¥å£å‡½æ•°å’Œä¾èµ–ä»£ç 
   - å»ºç«‹ç¬¦å·è¡¨

4. **åˆå§‹åŒ–**ï¼ˆ~2-5msï¼‰
   - åˆå§‹åŒ–äº‹ä»¶å¾ªç¯
   - è®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—

**æ€»å¼€é”€ï¼š10-30ms**

**âš ï¸ æ€§èƒ½å½±å“ï¼š**

```dart
// âŒ é”™è¯¯ï¼šé¢‘ç¹åˆ›å»º Isolate
for (int i = 0; i < 100; i++) {
  // æ¯æ¬¡åˆ›å»ºå¼€é”€ ~20msï¼Œæ€»è®¡ 2000ms
  await compute(processItem, items[i]);
}

// âœ… æ­£ç¡®ï¼šå¤ç”¨ Isolate æˆ–æ‰¹é‡å¤„ç†
await compute(processAllItems, items); // åªåˆ›å»ºä¸€æ¬¡
```

### 3.3 åŒå‘é€šä¿¡æ¨¡å¼è¯¦è§£

#### å•å‘é€šä¿¡ï¼ˆä¸» â†’ Isolateï¼‰

æœ€ç®€å•çš„é€šä¿¡æ¨¡å¼ï¼šä¸» Isolate å‘ Worker Isolate å‘é€æ¶ˆæ¯ã€‚

```dart
import 'dart:isolate';

// Worker Isolate å…¥å£å‡½æ•°
void workerFunction(SendPort mainSendPort) {
  // åˆ›å»ºè‡ªå·±çš„æ¥æ”¶ç«¯å£
  final workerReceivePort = ReceivePort();

  // å°†è‡ªå·±çš„ SendPort å‘é€ç»™ä¸» Isolate
  mainSendPort.send(workerReceivePort.sendPort);

  // ç›‘å¬æ¥è‡ªä¸» Isolate çš„æ¶ˆæ¯
  workerReceivePort.listen((message) {
    print('Worker æ”¶åˆ°ï¼š$message');

    // å¤„ç†æ¶ˆæ¯
    if (message == 'stop') {
      workerReceivePort.close();
    }
  });
}

// ä¸» Isolate
Future<void> main() async {
  final receivePort = ReceivePort();

  // å¯åŠ¨ Worker
  await Isolate.spawn(workerFunction, receivePort.sendPort);

  // è·å– Worker çš„ SendPort
  final workerSendPort = await receivePort.first as SendPort;

  // å‘ Worker å‘é€æ¶ˆæ¯
  workerSendPort.send('Hello');
  workerSendPort.send('World');
  workerSendPort.send('stop');
}
```

#### åŒå‘é€šä¿¡ï¼ˆä¸» â‡„ Isolateï¼‰

æ›´å¸¸è§çš„æ¨¡å¼ï¼šä¸» Isolate å’Œ Worker Isolate å¯ä»¥äº’ç›¸å‘é€æ¶ˆæ¯ã€‚

```dart
import 'dart:isolate';

// Worker Isolate
void workerFunction(SendPort mainSendPort) {
  final workerReceivePort = ReceivePort();

  // å‘é€è‡ªå·±çš„ SendPort
  mainSendPort.send(workerReceivePort.sendPort);

  workerReceivePort.listen((message) {
    if (message is Map) {
      final data = message['data'];
      final replyPort = message['replyPort'] as SendPort;

      // å¤„ç†æ•°æ®
      final result = processData(data);

      // å‘é€ç»“æœå›ä¸» Isolate
      replyPort.send(result);
    }
  });
}

int processData(int data) {
  return data * 2;
}

// ä¸» Isolate
Future<void> main() async {
  final receivePort = ReceivePort();

  await Isolate.spawn(workerFunction, receivePort.sendPort);

  final workerSendPort = await receivePort.first as SendPort;

  // åˆ›å»ºå›å¤ç«¯å£
  final replyPort = ReceivePort();

  // å‘é€è¯·æ±‚ï¼ŒåŒ…å«å›å¤ç«¯å£
  workerSendPort.send({
    'data': 42,
    'replyPort': replyPort.sendPort,
  });

  // ç­‰å¾…å“åº”
  final result = await replyPort.first;
  print('ç»“æœï¼š$result'); // è¾“å‡ºï¼šç»“æœï¼š84
}
```

#### å¤š Isolate é€šä¿¡æ¨¡å¼

åœ¨å¤æ‚åº”ç”¨ä¸­ï¼Œå¯èƒ½éœ€è¦å¤šä¸ª Worker Isolate ååŒå·¥ä½œã€‚

```dart
// Worker Pool æ¨¡å¼
class IsolatePool {
  final List<SendPort> _workers = [];
  int _currentWorker = 0;

  Future<void> init(int workerCount) async {
    for (int i = 0; i < workerCount; i++) {
      final receivePort = ReceivePort();
      await Isolate.spawn(_workerFunction, receivePort.sendPort);
      final workerSendPort = await receivePort.first as SendPort;
      _workers.add(workerSendPort);
    }
  }

  // è½®è¯¢åˆ†é…ä»»åŠ¡
  Future<dynamic> execute(dynamic data) async {
    final replyPort = ReceivePort();
    final worker = _workers[_currentWorker];

    worker.send({
      'data': data,
      'replyPort': replyPort.sendPort,
    });

    _currentWorker = (_currentWorker + 1) % _workers.length;

    return await replyPort.first;
  }

  static void _workerFunction(SendPort mainSendPort) {
    final receivePort = ReceivePort();
    mainSendPort.send(receivePort.sendPort);

    receivePort.listen((message) {
      final data = message['data'];
      final replyPort = message['replyPort'] as SendPort;

      // å¤„ç†ä»»åŠ¡
      final result = _processTask(data);

      replyPort.send(result);
    });
  }

  static dynamic _processTask(dynamic data) {
    // å®é™…çš„å¤„ç†é€»è¾‘
    return data;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
Future<void> main() async {
  final pool = IsolatePool();
  await pool.init(4); // åˆ›å»º 4 ä¸ª Worker

  // å¹¶è¡Œå¤„ç†å¤šä¸ªä»»åŠ¡
  final results = await Future.wait([
    pool.execute(1),
    pool.execute(2),
    pool.execute(3),
    pool.execute(4),
  ]);

  print('ç»“æœï¼š$results');
}
```

#### å¸¸è§é”™è¯¯ï¼šå¿˜è®°å…³é—­ ReceivePort

**âŒ é”™è¯¯ç¤ºä¾‹ï¼š**

```dart
Future<int> computeValue(int input) async {
  final receivePort = ReceivePort();

  await Isolate.spawn(_worker, {
    'input': input,
    'sendPort': receivePort.sendPort,
  });

  final result = await receivePort.first as int;

  // âŒ å¿˜è®°å…³é—­ ReceivePort
  return result;
}

// é—®é¢˜ï¼šæ¯æ¬¡è°ƒç”¨éƒ½ä¼šæ³„æ¼ä¸€ä¸ª ReceivePort
for (int i = 0; i < 100; i++) {
  await computeValue(i); // æ³„æ¼ 100 ä¸ª ReceivePort
}
```

**âœ… æ­£ç¡®ç¤ºä¾‹ï¼š**

```dart
Future<int> computeValue(int input) async {
  final receivePort = ReceivePort();

  await Isolate.spawn(_worker, {
    'input': input,
    'sendPort': receivePort.sendPort,
  });

  final result = await receivePort.first as int;

  // âœ… å…³é—­ ReceivePort
  receivePort.close();

  return result;
}
```

**âš ï¸ æœ€ä½³å®è·µï¼š**

ä½¿ç”¨ `try-finally` ç¡®ä¿ ReceivePort æ€»æ˜¯è¢«å…³é—­ï¼š

```dart
Future<int> computeValueSafe(int input) async {
  final receivePort = ReceivePort();

  try {
    await Isolate.spawn(_worker, {
      'input': input,
      'sendPort': receivePort.sendPort,
    });

    return await receivePort.first as int;
  } finally {
    // ç¡®ä¿æ€»æ˜¯å…³é—­
    receivePort.close();
  }
}
```

---

### 3.4 æ•°æ®åºåˆ—åŒ–æ·±åº¦åˆ†æ

#### å¯ä¼ é€’çš„æ•°æ®ç±»å‹å®Œæ•´åˆ—è¡¨

**åŸºæœ¬ç±»å‹ï¼š** `null`ã€`bool`ã€`int`ã€`double`ã€`String`

**é›†åˆç±»å‹ï¼š** `List<T>`ã€`Map<K, V>`ï¼ˆå…ƒç´ å¿…é¡»å¯åºåˆ—åŒ–ï¼‰

**æ³¨æ„ï¼š** `Set<T>` ä¸èƒ½ç›´æ¥ä¼ é€’ï¼Œéœ€è¦å…ˆè½¬æ¢ä¸º `List`ï¼š`mySet.toList()`

**TypedDataï¼š** `Uint8List`ã€`Int8List`ã€`Uint16List`ã€`Int16List`ã€`Uint32List`ã€`Int32List`ã€`Float32List`ã€`Float64List`ï¼ˆæ™®é€šæ¶ˆæ¯ä¼ é€’ä¼šå¤åˆ¶æ•´å—å†…å­˜ï¼‰

**Transferable TypedDataï¼ˆçœŸæ­£é›¶æ‹·è´ï¼‰ï¼š** `TransferableTypedData`ã€`ImmutableBuffer.fromUint8List()`ï¼ˆä¸€æ¬¡æ€§ç¼“å†²åŒºï¼Œéœ€åœ¨ç›®æ ‡ Isolate è°ƒç”¨ `materialize()`ï¼‰

**ç‰¹æ®Šç±»å‹ï¼š** `SendPort`ã€`Capability`

#### TransferableTypedData å®æˆ˜ç¤ºä¾‹

`TransferableTypedData` æ˜¯ Dart 2.15+ å¼•å…¥çš„ APIï¼Œç”¨äºåœ¨ Isolate ä¹‹é—´å®ç°çœŸæ­£çš„é›¶æ‹·è´æ•°æ®ä¼ é€’ã€‚

**åŸºæœ¬ç”¨æ³•ï¼š**

```dart
import 'dart:isolate';
import 'dart:typed_data';

// å‘é€ç«¯ï¼šåˆ›å»º TransferableTypedData
Future<void> sendLargeData(Uint8List data, SendPort sendPort) async {
  // å°† Uint8List è½¬æ¢ä¸º TransferableTypedData
  final transferable = TransferableTypedData.fromList([data]);

  // å‘é€åï¼ŒåŸå§‹ data ä¸åº”å†è¢«è®¿é—®
  sendPort.send(transferable);

  // âš ï¸ è­¦å‘Šï¼šæ­¤æ—¶ data å·²è¢«"ç§»åŠ¨"ï¼Œä¸åº”ç»§ç»­ä½¿ç”¨
}

// æ¥æ”¶ç«¯ï¼šmaterialize æ•°æ®
void receiveLargeData(TransferableTypedData message) {
  // å°† TransferableTypedData "ç‰©åŒ–"ä¸º ByteData
  final byteData = message.materialize();

  // è½¬æ¢ä¸º Uint8List ä½¿ç”¨
  final data = byteData.buffer.asUint8List();

  // ç°åœ¨å¯ä»¥å®‰å…¨åœ°å¤„ç† data
  print('æ¥æ”¶åˆ° ${data.length} å­—èŠ‚æ•°æ®');
}
```

**å®Œæ•´ç¤ºä¾‹ï¼šå¤§æ–‡ä»¶å¤„ç†**

```dart
import 'dart:isolate';
import 'dart:typed_data';

class ZeroCopyProcessor {
  late Isolate _isolate;
  late SendPort _sendPort;

  Future<void> start() async {
    final receivePort = ReceivePort();
    _isolate = await Isolate.spawn(_workerFunction, receivePort.sendPort);
    _sendPort = await receivePort.first as SendPort;
    receivePort.close();
  }

  Future<void> processLargeFile(Uint8List fileData) async {
    final replyPort = ReceivePort();

    // åˆ›å»º TransferableTypedData
    final transferable = TransferableTypedData.fromList([fileData]);

    _sendPort.send({
      'data': transferable,
      'replyPort': replyPort.sendPort,
    });

    await replyPort.first;
    replyPort.close();
  }

  void stop() => _isolate.kill(priority: Isolate.beforeNextEvent);

  static void _workerFunction(SendPort mainSendPort) {
    final receivePort = ReceivePort();
    mainSendPort.send(receivePort.sendPort);

    receivePort.listen((message) {
      final transferable = message['data'] as TransferableTypedData;
      final replyPort = message['replyPort'] as SendPort;

      // ç‰©åŒ–æ•°æ®
      final byteData = transferable.materialize();
      final data = byteData.buffer.asUint8List();

      // å¤„ç†æ•°æ®ï¼ˆä¾‹å¦‚ï¼šå‹ç¼©ã€åŠ å¯†ç­‰ï¼‰
      // ...

      replyPort.send('done');
    });
  }
}
```

**æ€§èƒ½å¯¹æ¯”ï¼š**

| ä¼ é€’æ–¹å¼ | 10MB æ•°æ® | 100MB æ•°æ® | è¯´æ˜ |
|---------|----------|-----------|------|
| æ™®é€š SendPort | ~50ms | ~500ms | éœ€è¦å¤åˆ¶æ•´å—å†…å­˜ |
| TransferableTypedData | ~2ms | ~5ms | é›¶æ‹·è´ï¼Œä»…ä¼ é€’æŒ‡é’ˆ |

**âš ï¸ é‡è¦é™åˆ¶ï¼š**

1. **ä¸€æ¬¡æ€§ä½¿ç”¨**ï¼šæ•°æ®åªèƒ½"ç§»åŠ¨"ä¸€æ¬¡ï¼Œå‘é€ååŸ Isolate ä¸åº”ç»§ç»­è®¿é—®
2. **materialize åå¤±æ•ˆ**ï¼šåœ¨ç›®æ ‡ Isolate è°ƒç”¨ `materialize()` åï¼ŒåŸç¼“å†²åŒºå¤±æ•ˆï¼Œæ— æ³•å†æ¬¡å‘é€
3. **ç‰ˆæœ¬è¦æ±‚**ï¼šéœ€è¦ Dart 2.15+ / Flutter 2.8+

#### åºåˆ—åŒ–çš„æ€§èƒ½æˆæœ¬æµ‹è¯•

```dart
import 'dart:typed_data';

// æ€§èƒ½å¯¹æ¯”æµ‹è¯•
Future<void> testPerformance() async {
  // å°å¯¹è±¡ï¼š~15ms
  await compute(_processInt, 42);

  // å¤§ Listï¼š~150msï¼ˆåŒ…å«åºåˆ—åŒ–ï¼‰
  await compute(_processList, List.generate(1000000, (i) => i));

  // Uint8Listï¼š~20msï¼ˆé›¶æ‹·è´ï¼‰
  await compute(_processBytes, Uint8List(1000000));
}
```

**âš ï¸ ä¼˜åŒ–å»ºè®®ï¼š** ä¼˜å…ˆä½¿ç”¨ `Uint8List` ç­‰ TypedData ç±»å‹ä¼ é€’å¤§å‹æ•°æ®ï¼Œå¯ä»¥åˆ©ç”¨é›¶æ‹·è´æŠ€æœ¯å¤§å¹…æå‡æ€§èƒ½ã€‚

### 3.5 ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ€ä½³å®è·µ

#### é•¿æœŸè¿è¡Œ Worker æ¨¡å¼

```dart
class LongRunningWorker {
  late Isolate _isolate;
  late SendPort _sendPort;

  Future<void> start() async {
    final receivePort = ReceivePort();
    _isolate = await Isolate.spawn(_workerFunction, receivePort.sendPort);
    _sendPort = await receivePort.first as SendPort;

    // âœ… åŠæ—¶å…³é—­æ¡æ‰‹ç«¯å£ï¼Œé¿å…èµ„æºæ³„æ¼
    receivePort.close();
  }

  Future<dynamic> execute(dynamic data) async {
    final replyPort = ReceivePort();
    _sendPort.send({'data': data, 'replyPort': replyPort.sendPort});

    try {
      return await replyPort.first;
    } finally {
      // âœ… ç¡®ä¿æ¯æ¬¡è°ƒç”¨åéƒ½å…³é—­å›å¤ç«¯å£
      replyPort.close();
    }
  }

  void stop() {
    // âœ… ä½¿ç”¨ beforeNextEvent ä¼˜é›…ç»ˆæ­¢
    _isolate.kill(priority: Isolate.beforeNextEvent);
  }

  static void _workerFunction(SendPort mainSendPort) {
    final receivePort = ReceivePort();
    mainSendPort.send(receivePort.sendPort);
    receivePort.listen((message) {
      final data = message['data'];
      final replyPort = message['replyPort'] as SendPort;
      replyPort.send(_processData(data));
    });
  }

  static dynamic _processData(dynamic data) => data;
}
```

#### æ­£ç¡®çš„æ¸…ç†æµç¨‹

```dart
class IsolateManager {
  Isolate? _isolate;
  ReceivePort? _receivePort;
  SendPort? _sendPort; // âœ… å£°æ˜ _sendPort å­—æ®µ

  Future<void> start() async {
    final receivePort = ReceivePort();
    _receivePort = receivePort;

    _isolate = await Isolate.spawn(_workerFunction, receivePort.sendPort);
    _sendPort = await receivePort.first as SendPort;

    // å…³é—­æ¡æ‰‹ç«¯å£
    receivePort.close();
    _receivePort = null;
  }

  Future<void> dispose() async {
    // 1. å‘é€åœæ­¢ä¿¡å·
    _sendPort?.send('stop');

    // 2. ç­‰å¾…æ¸…ç†
    await Future.delayed(Duration(milliseconds: 100));

    // 3. å…³é—­ç«¯å£
    _receivePort?.close();

    // 4. ç»ˆæ­¢ Isolate
    _isolate?.kill(priority: Isolate.beforeNextEvent);

    // 5. æ¸…ç©ºå¼•ç”¨
    _isolate = null;
    _receivePort = null;
    _sendPort = null; // âœ… æ¸…ç©º _sendPort
  }

  static void _workerFunction(SendPort mainSendPort) {
    final receivePort = ReceivePort();
    mainSendPort.send(receivePort.sendPort);

    receivePort.listen((message) {
      if (message == 'stop') {
        receivePort.close();
      }
      // å¤„ç†å…¶ä»–æ¶ˆæ¯...
    });
  }
}
```

### 3.6 é”™è¯¯å¤„ç†ä¸å¼‚å¸¸ä¼ æ’­

#### åœ¨ Worker å†…éƒ¨æ•è·å¼‚å¸¸

```dart
void _workerFunction(SendPort mainSendPort) {
  final receivePort = ReceivePort();
  mainSendPort.send(receivePort.sendPort);

  receivePort.listen((message) {
    try {
      final result = riskyOperation(message);
      mainSendPort.send({'success': true, 'result': result});
    } catch (e, stackTrace) {
      mainSendPort.send({
        'success': false,
        'error': e.toString(),
        'stackTrace': stackTrace.toString(),
      });
    }
  });
}
```

#### ä½¿ç”¨ onError ç«¯å£

```dart
Future<void> createIsolateWithErrorHandling() async {
  final receivePort = ReceivePort();
  final errorPort = ReceivePort();

  errorPort.listen((errorData) {
    print('é”™è¯¯ï¼š${errorData[0]}');
    print('å †æ ˆï¼š${errorData[1]}');
  });

  await Isolate.spawn(
    _workerFunction,
    receivePort.sendPort,
    onError: errorPort.sendPort,
    errorsAreFatal: false,
  );
}
```

**âš ï¸ æœ€ä½³å®è·µï¼š** å§‹ç»ˆåœ¨ Worker å†…éƒ¨ä½¿ç”¨ try-catch æ•è·å¼‚å¸¸ï¼Œå¹¶é€šè¿‡æ¶ˆæ¯ä¼ é€’é”™è¯¯ä¿¡æ¯ï¼Œé¿å… Isolate å´©æºƒã€‚

---

### 3.7 å®æˆ˜ä»£ç ç¤ºä¾‹

#### åœºæ™¯1ï¼šå›¾ç‰‡å‹ç¼©ï¼ˆå¤§æ–‡ä»¶å¤„ç†ï¼‰

```dart
import 'dart:typed_data';
import 'dart:isolate';
import 'package:image/image.dart' as img;

// å›¾ç‰‡å‹ç¼©æœåŠ¡
class ImageCompressor {
  Future<Uint8List> compress(Uint8List imageData, int quality) async {
    return await compute(_compressImage, {
      'imageData': imageData,
      'quality': quality,
    });
  }

  static Uint8List _compressImage(Map<String, dynamic> params) {
    final imageData = params['imageData'] as Uint8List;
    final quality = params['quality'] as int;

    // è§£ç å›¾ç‰‡
    final image = img.decodeImage(imageData);
    if (image == null) throw Exception('æ— æ³•è§£ç å›¾ç‰‡');

    // å‹ç¼©å›¾ç‰‡
    return Uint8List.fromList(img.encodeJpg(image, quality: quality));
  }
}
```

#### åœºæ™¯2ï¼šJSON è§£æï¼ˆå¤§æ•°æ®å¤„ç†ï¼‰

```dart
import 'dart:convert';

Future<List<User>> parseUsers(String jsonString) async {
  return await compute(_parseUsersInBackground, jsonString);
}

List<User> _parseUsersInBackground(String jsonString) {
  final List<dynamic> jsonList = jsonDecode(jsonString);
  return jsonList.map((json) => User.fromJson(json)).toList();
}
```

#### åœºæ™¯3ï¼šWorker Poolï¼ˆå¤šä»»åŠ¡å¹¶è¡Œï¼‰

```dart
class WorkerPool {
  final List<SendPort> _workers = [];
  int _currentWorker = 0;

  Future<void> init(int count) async {
    for (int i = 0; i < count; i++) {
      final receivePort = ReceivePort();
      await Isolate.spawn(_worker, receivePort.sendPort);
      _workers.add(await receivePort.first as SendPort);
    }
  }

  Future<dynamic> execute(dynamic task) async {
    final replyPort = ReceivePort();
    _workers[_currentWorker].send({'task': task, 'reply': replyPort.sendPort});
    _currentWorker = (_currentWorker + 1) % _workers.length;
    return await replyPort.first;
  }

  static void _worker(SendPort mainSendPort) {
    final receivePort = ReceivePort();
    mainSendPort.send(receivePort.sendPort);
    receivePort.listen((message) {
      final task = message['task'];
      final replyPort = message['reply'] as SendPort;
      replyPort.send(_processTask(task));
    });
  }

  static dynamic _processTask(dynamic task) => task;
}
```

### 3.8 æ€§èƒ½åˆ†æä¸æƒè¡¡

#### å¯åŠ¨å¼€é”€å¯¹æ¯”

| æ“ä½œ | æ—¶é—´å¼€é”€ | è¯´æ˜ |
|------|---------|------|
| åˆ›å»º Isolate | 10-30ms | åŒ…å«å†…å­˜åˆ†é…ã€çº¿ç¨‹åˆ›å»º |
| æ¶ˆæ¯ä¼ é€’ï¼ˆå°å¯¹è±¡ï¼‰ | <1ms | åŸºæœ¬ç±»å‹ä¼ é€’å¾ˆå¿« |
| æ¶ˆæ¯ä¼ é€’ï¼ˆå¤§ Listï¼‰ | 10-100ms | éœ€è¦åºåˆ—åŒ– |
| æ¶ˆæ¯ä¼ é€’ï¼ˆUint8Listï¼‰ | 5-15ms | éœ€è¦å¤åˆ¶æ•´å—å†…å­˜ |
| æ¶ˆæ¯ä¼ é€’ï¼ˆTransferableTypedDataï¼‰ | 1-5ms | çœŸæ­£é›¶æ‹·è´ï¼Œä¸€æ¬¡æ€§ç¼“å†²åŒº |

#### ä½•æ—¶å€¼å¾—ä½¿ç”¨ Isolateï¼Ÿ

**å€¼å¾—ä½¿ç”¨çš„åœºæ™¯ï¼š**
- ä»»åŠ¡æ‰§è¡Œæ—¶é—´ > 50ms
- CPU å¯†é›†å‹æ“ä½œï¼ˆå›¾ç‰‡å¤„ç†ã€åŠ å¯†ã€æ’åºï¼‰
- éœ€è¦ä¿æŒ UI æµç•…æ€§

**ä¸å€¼å¾—ä½¿ç”¨çš„åœºæ™¯ï¼š**
- ä»»åŠ¡æ‰§è¡Œæ—¶é—´ < 16ms
- I/O å¯†é›†å‹æ“ä½œï¼ˆä½¿ç”¨ async/await å³å¯ï¼‰
- é¢‘ç¹åˆ›å»ºé”€æ¯ï¼ˆå¼€é”€å¤§äºæ”¶ç›Šï¼‰

### 3.9 å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ

#### é™·é˜±1ï¼šè¿‡åº¦ä½¿ç”¨å¯¼è‡´èµ„æºæµªè´¹

```dart
// âŒ é”™è¯¯ï¼šä¸ºæ¯ä¸ªå°ä»»åŠ¡åˆ›å»º Isolate
for (int i = 0; i < 100; i++) {
  await compute(smallTask, i); // åˆ›å»º100æ¬¡ï¼Œå¼€é”€2000ms
}

// âœ… æ­£ç¡®ï¼šæ‰¹é‡å¤„ç†æˆ–ä½¿ç”¨ Worker Pool
await compute(batchProcess, items); // åªåˆ›å»º1æ¬¡
```

#### é™·é˜±2ï¼šå¿˜è®°é‡Šæ”¾èµ„æº

```dart
// âŒ é”™è¯¯ï¼šæ²¡æœ‰ dispose
class MyService {
  Isolate? _isolate;
  Future<void> start() async {
    _isolate = await Isolate.spawn(_worker, data);
  }
}

// âœ… æ­£ç¡®ï¼šå®ç° dispose
class MyService {
  Isolate? _isolate;
  void dispose() {
    _isolate?.kill();
  }
}
```

#### é™·é˜±3ï¼šä¼ é€’ä¸å¯åºåˆ—åŒ–å¯¹è±¡

```dart
// âŒ é”™è¯¯ï¼šä¼ é€’å‡½æ•°
compute(myFunction, data); // é”™è¯¯ï¼

// âœ… æ­£ç¡®ï¼šä¼ é€’æ•°æ®
compute(_staticFunction, data);
static void _staticFunction(data) { }
```

#### é™·é˜±4ï¼šæ­»é”å’Œç«æ€æ¡ä»¶

è™½ç„¶ Isolate é¿å…äº†ä¼ ç»Ÿçš„æ­»é”ï¼Œä½†ä»å¯èƒ½å‡ºç°é€»è¾‘æ­»é”ï¼š

```dart
// âŒ é”™è¯¯ï¼šç›¸äº’ç­‰å¾…
// Isolate A ç­‰å¾… B çš„å“åº”
// Isolate B ç­‰å¾… A çš„å“åº”
// å¯¼è‡´ä¸¤è€…éƒ½æ— æ³•ç»§ç»­

// âœ… æ­£ç¡®ï¼šè®¾è®¡æ¸…æ™°çš„é€šä¿¡æµç¨‹
// ä½¿ç”¨è¯·æ±‚-å“åº”æ¨¡å¼ï¼Œé¿å…å¾ªç¯ä¾èµ–
```

### 3.10 é€‚ç”¨åœºæ™¯å†³ç­–æ ‘

```
éœ€è¦æ‰§è¡Œè€—æ—¶æ“ä½œï¼Ÿ
    â”‚
    â”œâ”€ æ˜¯ I/O æ“ä½œï¼Ÿ
    â”‚   â””â”€ æ˜¯ â†’ ä½¿ç”¨ async/await
    â”‚
    â””â”€ æ˜¯ CPU å¯†é›†å‹ï¼Ÿ
        â”‚
        â”œâ”€ æ‰§è¡Œæ—¶é—´ < 16msï¼Ÿ
        â”‚   â””â”€ æ˜¯ â†’ ä¸»çº¿ç¨‹æ‰§è¡Œ
        â”‚
        â”œâ”€ æ‰§è¡Œæ—¶é—´ 16-50msï¼Ÿ
        â”‚   â””â”€ è€ƒè™‘ä½¿ç”¨ Isolateï¼ˆå–å†³äºé¢‘ç‡ï¼‰
        â”‚
        â””â”€ æ‰§è¡Œæ—¶é—´ > 50msï¼Ÿ
            â”‚
            â”œâ”€ ä¸€æ¬¡æ€§ä»»åŠ¡ï¼Ÿ
            â”‚   â””â”€ ä½¿ç”¨ compute
            â”‚
            â”œâ”€ é¢‘ç¹æ‰§è¡Œï¼Ÿ
            â”‚   â””â”€ ä½¿ç”¨é•¿æœŸ Worker
            â”‚
            â””â”€ éœ€è¦åŸç”Ÿæ€§èƒ½ï¼Ÿ
                â””â”€ ä½¿ç”¨ Platform Channels
```

**å¿«é€Ÿé€‰æ‹©æŒ‡å—ï¼š**

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | åŸå›  |
|------|---------|------|
| å›¾ç‰‡å¤„ç† | compute æˆ– Isolate | CPU å¯†é›†ï¼Œè€—æ—¶é•¿ |
| JSON è§£æï¼ˆå¤§ï¼‰ | compute | CPU å¯†é›†ï¼Œä¸€æ¬¡æ€§ |
| æ•°æ®åº“æ“ä½œ | async/await | I/O æ“ä½œ |
| ç½‘ç»œè¯·æ±‚ | async/await | I/O æ“ä½œ |
| åŠ å¯†è§£å¯† | compute | CPU å¯†é›† |
| å®æ—¶éŸ³è§†é¢‘ | Platform Channels | éœ€è¦åŸç”Ÿæ€§èƒ½ |

---

## å››ã€compute å‡½æ•°æ·±åº¦è¯¦è§£

### 4.1 æ ¸å¿ƒ API ä¸è®¾è®¡ç†å¿µ

#### compute() çš„å‡½æ•°ç­¾å

```dart
Future<R> compute<Q, R>(
  ComputeCallback<Q, R> callback,  // å›è°ƒå‡½æ•°
  Q message,                        // ä¼ é€’çš„å‚æ•°
  {String? debugLabel}              // è°ƒè¯•æ ‡ç­¾
)

typedef ComputeCallback<Q, R> = FutureOr<R> Function(Q message);
```

#### ä¸ºä»€ä¹ˆè®¾è®¡æˆè¿™æ ·ï¼Ÿ

**ç®€åŒ– vs çµæ´»æ€§çš„æƒè¡¡ï¼š**

`compute` æ˜¯ Flutter å¯¹ `Isolate.spawn` çš„é«˜çº§å°è£…ï¼Œç‰ºç‰²äº†ä¸€äº›çµæ´»æ€§æ¢å–äº†æå¤§çš„æ˜“ç”¨æ€§ï¼š

| ç‰¹æ€§ | Isolate.spawn | compute |
|------|--------------|---------|
| æ˜“ç”¨æ€§ | å¤æ‚ | ç®€å• |
| çµæ´»æ€§ | é«˜ | ä½ |
| ç”Ÿå‘½å‘¨æœŸ | æ‰‹åŠ¨ç®¡ç† | è‡ªåŠ¨ç®¡ç† |
| é€šä¿¡æ¨¡å¼ | åŒå‘ | å•å‘ï¼ˆè¯·æ±‚-å“åº”ï¼‰|
| é€‚ç”¨åœºæ™¯ | å¤æ‚ä»»åŠ¡ | ä¸€æ¬¡æ€§ä»»åŠ¡ |

### 4.2 å‡½æ•°é™åˆ¶æ·±åº¦è§£æ

#### ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯é¡¶å±‚å‡½æ•°æˆ–é™æ€æ–¹æ³•ï¼Ÿ

```dart
// âœ… æ­£ç¡®ï¼šé¡¶å±‚å‡½æ•°
int topLevelFunction(int data) => data * 2;

// âœ… æ­£ç¡®ï¼šé™æ€æ–¹æ³•
class MyClass {
  static int staticMethod(int data) => data * 2;
}

// âŒ é”™è¯¯ï¼šå®ä¾‹æ–¹æ³•
class MyClass {
  int instanceMethod(int data) => data * 2; // ä¸èƒ½ç”¨äº compute
}

// âŒ é”™è¯¯ï¼šé—­åŒ…
final x = 10;
final closure = (int data) => data + x; // ä¸èƒ½ç”¨äº compute
```

**åŸå› ï¼š** Isolate éœ€è¦èƒ½å¤Ÿåœ¨ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ä¸­é‡å»ºå‡½æ•°ï¼Œå®ä¾‹æ–¹æ³•å’Œé—­åŒ…ä¾èµ–å¤–éƒ¨çŠ¶æ€ï¼Œæ— æ³•åºåˆ—åŒ–ä¼ é€’ã€‚

#### ä¸ºä»€ä¹ˆåªèƒ½æœ‰ä¸€ä¸ªå‚æ•°ï¼Ÿ

```dart
// âœ… æ­£ç¡®ï¼šå•ä¸€å‚æ•°
int process(int data) => data * 2;

// âŒ é”™è¯¯ï¼šå¤šä¸ªå‚æ•°
int process(int a, int b) => a + b; // ä¸èƒ½ç”¨äº compute

// âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ Map æˆ–è‡ªå®šä¹‰ç±»
int process(Map<String, int> params) {
  return params['a']! + params['b']!;
}

await compute(process, {'a': 1, 'b': 2});
```

### 4.3 è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†æœºåˆ¶

#### compute å¦‚ä½•è‡ªåŠ¨åˆ›å»ºå’Œé”€æ¯ Isolateï¼Ÿ

```dart
// compute çš„å†…éƒ¨å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰
Future<R> compute<Q, R>(ComputeCallback<Q, R> callback, Q message) async {
  final receivePort = ReceivePort();

  // 1. åˆ›å»º Isolate
  final isolate = await Isolate.spawn(
    _spawn,
    _IsolateConfiguration(callback, message, receivePort.sendPort),
  );

  // 2. ç­‰å¾…ç»“æœ
  final result = await receivePort.first as R;

  // 3. è‡ªåŠ¨é”€æ¯ Isolate
  isolate.kill();
  receivePort.close();

  return result;
}
```

**æ€§èƒ½ä»£ä»·ï¼š** æ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºæ–° Isolateï¼Œå¼€é”€çº¦ 10-30msã€‚

### 4.4 æ€§èƒ½å¼€é”€æ·±åº¦åˆ†æ

#### ä¸´ç•Œç‚¹ï¼šå¤šå¤§çš„ä»»åŠ¡æ‰å€¼å¾—ç”¨ computeï¼Ÿ

```dart
// æ€§èƒ½æµ‹è¯•
Future<void> performanceTest() async {
  // æµ‹è¯• 1ï¼šå°ä»»åŠ¡ï¼ˆ5msï¼‰
  final stopwatch1 = Stopwatch()..start();
  await compute(_smallTask, 100);
  stopwatch1.stop();
  print('å°ä»»åŠ¡ï¼š${stopwatch1.elapsedMilliseconds}ms'); // ~20msï¼ˆå¼€é”€ > ä»»åŠ¡ï¼‰

  // æµ‹è¯• 2ï¼šä¸­ç­‰ä»»åŠ¡ï¼ˆ50msï¼‰
  final stopwatch2 = Stopwatch()..start();
  await compute(_mediumTask, 10000);
  stopwatch2.stop();
  print('ä¸­ç­‰ä»»åŠ¡ï¼š${stopwatch2.elapsedMilliseconds}ms'); // ~70msï¼ˆå€¼å¾—ï¼‰

  // æµ‹è¯• 3ï¼šå¤§ä»»åŠ¡ï¼ˆ200msï¼‰
  final stopwatch3 = Stopwatch()..start();
  await compute(_largeTask, 100000);
  stopwatch3.stop();
  print('å¤§ä»»åŠ¡ï¼š${stopwatch3.elapsedMilliseconds}ms'); // ~220msï¼ˆéå¸¸å€¼å¾—ï¼‰
}
```

**ç»“è®ºï¼š** ä»»åŠ¡æ‰§è¡Œæ—¶é—´ > 50ms æ—¶ï¼Œä½¿ç”¨ compute æ‰æœ‰æ˜æ˜¾æ”¶ç›Šã€‚

### 4.5 å®æˆ˜ä»£ç ç¤ºä¾‹

#### åœºæ™¯1ï¼šå›¾ç‰‡æ»¤é•œå¤„ç†

```dart
import 'dart:typed_data';
import 'package:flutter/foundation.dart';

Future<Uint8List> applyFilter(Uint8List imageData) async {
  return await compute(_applyFilterInBackground, imageData);
}

Uint8List _applyFilterInBackground(Uint8List imageData) {
  // åº”ç”¨æ»¤é•œç®—æ³•
  for (int i = 0; i < imageData.length; i += 4) {
    imageData[i] = (imageData[i] * 0.8).toInt();     // R
    imageData[i+1] = (imageData[i+1] * 0.8).toInt(); // G
    imageData[i+2] = (imageData[i+2] * 0.8).toInt(); // B
  }
  return imageData;
}
```

#### åœºæ™¯2ï¼šå¤§å‹ JSON è§£æ

```dart
import 'dart:convert';

Future<List<Product>> parseProducts(String jsonString) async {
  return await compute(_parseProductsInBackground, jsonString);
}

List<Product> _parseProductsInBackground(String jsonString) {
  final List<dynamic> jsonList = jsonDecode(jsonString);
  return jsonList.map((json) => Product.fromJson(json)).toList();
}
```

### 4.6 å¸¸è§é”™è¯¯ä¸æ­£ç¡®åšæ³•å¯¹æ¯”

#### é”™è¯¯1ï¼šåœ¨ compute ä¸­è®¿é—®å…¨å±€å˜é‡

```dart
// âŒ é”™è¯¯
int globalValue = 10;

int wrongFunction(int data) {
  return data + globalValue; // é”™è¯¯ï¼Isolate ä¸­æ— æ³•è®¿é—®
}

// âœ… æ­£ç¡®
int correctFunction(Map<String, int> params) {
  return params['data']! + params['globalValue']!;
}

await compute(correctFunction, {'data': 5, 'globalValue': 10});
```

#### é”™è¯¯2ï¼šä¼ é€’ä¸å¯åºåˆ—åŒ–å‚æ•°

```dart
// âŒ é”™è¯¯
class MyClass {
  final Function callback; // ä¸å¯åºåˆ—åŒ–
  MyClass(this.callback);
}

await compute(process, MyClass(() {})); // é”™è¯¯ï¼

// âœ… æ­£ç¡®ï¼šåªä¼ é€’æ•°æ®
await compute(process, {'value': 42});
```

#### é”™è¯¯3ï¼šç”¨ compute å¤„ç†éœ€è¦å¤šæ¬¡é€šä¿¡çš„ä»»åŠ¡

```dart
// âŒ é”™è¯¯ï¼šéœ€è¦å¤šæ¬¡é€šä¿¡
for (int i = 0; i < 10; i++) {
  await compute(process, i); // åˆ›å»º10æ¬¡ Isolate
}

// âœ… æ­£ç¡®ï¼šæ‰¹é‡å¤„ç†
await compute(processBatch, List.generate(10, (i) => i));
```

### 4.7 æ€§èƒ½ä¼˜åŒ–æŠ€å·§

#### æŠ€å·§1ï¼šæ‰¹é‡å¤„ç†

```dart
// âŒ ä½æ•ˆ
for (var item in items) {
  await compute(processItem, item); // N æ¬¡åˆ›å»º
}

// âœ… é«˜æ•ˆ
await compute(processAllItems, items); // 1 æ¬¡åˆ›å»º
```

#### æŠ€å·§2ï¼šä½¿ç”¨ TypedData

```dart
// âŒ ä½æ•ˆï¼šä¼ é€’ List
await compute(process, List.generate(1000000, (i) => i));

// âœ… é«˜æ•ˆï¼šä¼ é€’ Uint8Listï¼ˆé›¶æ‹·è´ï¼‰
await compute(process, Uint8List(1000000));
```

### 4.8 é€‚ç”¨åœºæ™¯ä¸é™åˆ¶

**é€‚ç”¨åœºæ™¯ï¼š**
- ä¸€æ¬¡æ€§ CPU å¯†é›†å‹ä»»åŠ¡
- ä»»åŠ¡æ‰§è¡Œæ—¶é—´ > 50ms
- ä¸éœ€è¦å¤šæ¬¡é€šä¿¡
- ç®€å•çš„è¯·æ±‚-å“åº”æ¨¡å¼

**é™åˆ¶ï¼š**
- åªèƒ½å•å‘é€šä¿¡
- æ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºæ–° Isolate
- å‡½æ•°å¿…é¡»æ˜¯é¡¶å±‚æˆ–é™æ€
- å‚æ•°å¿…é¡»å¯åºåˆ—åŒ–

**ä½•æ—¶åº”è¯¥æ”¹ç”¨ Isolate.spawnï¼Ÿ**
- éœ€è¦é•¿æœŸè¿è¡Œçš„ Worker
- éœ€è¦åŒå‘é€šä¿¡
- éœ€è¦å¤šæ¬¡äº¤äº’
- éœ€è¦æ›´ç²¾ç»†çš„æ§åˆ¶

---

## äº”ã€Isolate.run æ·±åº¦è¯¦è§£ (Flutter 3.7+)

### 5.1 æ–°ç‰¹æ€§ä¸è®¾è®¡ç›®æ ‡

**Isolate.run è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ**

`Isolate.run` æ˜¯ Dart 2.19 / Flutter 3.7 å¼•å…¥çš„æ–° APIï¼Œæ—¨åœ¨ç®€åŒ– Isolate çš„ä½¿ç”¨ï¼ŒåŒæ—¶æä¾›æ¯” `compute` æ›´å¤§çš„çµæ´»æ€§ã€‚

```dart
// Isolate.run çš„å‡½æ•°ç­¾å
static Future<R> run<R>(
  FutureOr<R> Function() computation,
  {String? debugName}
)
```

**ä¸ compute çš„æ ¸å¿ƒåŒºåˆ«ï¼š**

| ç‰¹æ€§ | compute | Isolate.run |
|------|---------|-------------|
| å‚æ•°ä¼ é€’ | å•ä¸€å‚æ•° | æ”¯æŒé—­åŒ…æ•è· |
| å‡½æ•°ç±»å‹ | é¡¶å±‚/é™æ€ | é¡¶å±‚/é™æ€/é—­åŒ… |
| çµæ´»æ€§ | ä½ | ä¸­ |
| ç‰ˆæœ¬è¦æ±‚ | æ‰€æœ‰ç‰ˆæœ¬ | Flutter 3.7+ |

### 5.2 é—­åŒ…æ”¯æŒçš„åŸç†ä¸é™·é˜±

#### ä¸ºä»€ä¹ˆ Isolate.run å¯ä»¥æ”¯æŒé—­åŒ…ï¼Ÿ

```dart
// âœ… Isolate.run æ”¯æŒé—­åŒ…
final multiplier = 2;
final result = await Isolate.run(() {
  return 42 * multiplier; // å¯ä»¥æ•è·å¤–éƒ¨å˜é‡
});

// âŒ compute ä¸æ”¯æŒ
await compute(() => 42 * multiplier, null); // é”™è¯¯ï¼
```

**åŸç†ï¼š** `Isolate.run` åœ¨åˆ›å»º Isolate æ—¶ä¼šåºåˆ—åŒ–é—­åŒ…æ•è·çš„å˜é‡ï¼Œå¹¶åœ¨æ–° Isolate ä¸­é‡å»ºã€‚

**âš ï¸ é™·é˜±ï¼šæ•è·ä¸å¯åºåˆ—åŒ–å¯¹è±¡**

```dart
// âŒ é”™è¯¯ï¼šæ•è·ä¸å¯åºåˆ—åŒ–å¯¹è±¡
final controller = TextEditingController();
await Isolate.run(() {
  return controller.text; // é”™è¯¯ï¼controller ä¸å¯åºåˆ—åŒ–
});

// âœ… æ­£ç¡®ï¼šåªæ•è·å¯åºåˆ—åŒ–æ•°æ®
final text = controller.text;
await Isolate.run(() {
  return text.toUpperCase();
});
```

### 5.3 ä¸ compute çš„è¯¦ç»†å¯¹æ¯”

```dart
// computeï¼šå¿…é¡»ä½¿ç”¨é¡¶å±‚å‡½æ•°
int _processData(int data) => data * 2;
await compute(_processData, 42);

// Isolate.runï¼šå¯ä»¥ä½¿ç”¨é—­åŒ…
final multiplier = 2;
await Isolate.run(() => 42 * multiplier);

// Isolate.runï¼šå¯ä»¥ä½¿ç”¨å®ä¾‹æ–¹æ³•ï¼ˆé—´æ¥ï¼‰
class Calculator {
  int multiply(int a, int b) => a * b;

  Future<int> compute(int a, int b) async {
    return await Isolate.run(() => multiply(a, b)); // é”™è¯¯ï¼
    // æ­£ç¡®åšæ³•ï¼š
    return await Isolate.run(() => a * b);
  }
}
```

**é€‰æ‹©å»ºè®®ï¼š**
- ç®€å•ä»»åŠ¡ â†’ ä½¿ç”¨ `Isolate.run`ï¼ˆæ›´ç®€æ´ï¼‰
- éœ€è¦ä¼ é€’å¤æ‚å‚æ•° â†’ ä½¿ç”¨ `compute`ï¼ˆæ›´æ˜ç¡®ï¼‰
- éœ€è¦é•¿æœŸ Worker â†’ ä½¿ç”¨ `Isolate.spawn`

### 5.4 å®æˆ˜ä»£ç ç¤ºä¾‹

```dart
// åœºæ™¯1ï¼šä½¿ç”¨é—­åŒ…ç®€åŒ–ä»£ç 
Future<List<int>> filterAndSort(List<int> numbers, int threshold) async {
  return await Isolate.run(() {
    return numbers.where((n) => n > threshold).toList()..sort();
  });
}

// åœºæ™¯2ï¼šå¤æ‚æ•°æ®å¤„ç†
Future<Map<String, int>> analyzeData(List<String> data) async {
  final prefix = 'item_';
  return await Isolate.run(() {
    final result = <String, int>{};
    for (var item in data) {
      if (item.startsWith(prefix)) {
        result[item] = item.length;
      }
    }
    return result;
  });
}
```

### 5.5 å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ

**é™·é˜±1ï¼šæ„å¤–æ•è·ä¸å¯åºåˆ—åŒ–å¯¹è±¡**

```dart
class MyWidget extends StatefulWidget {
  @override
  _MyWidgetState createState() => _MyWidgetState();
}

class _MyWidgetState extends State<MyWidget> {
  Future<void> processData() async {
    // âŒ é”™è¯¯ï¼šé—­åŒ…æ•è·äº† thisï¼ˆState å¯¹è±¡ä¸å¯åºåˆ—åŒ–ï¼‰
    await Isolate.run(() {
      setState(() {}); // é”™è¯¯ï¼
    });

    // âœ… æ­£ç¡®ï¼šåªæ•è·éœ€è¦çš„æ•°æ®
    final data = myData;
    final result = await Isolate.run(() => _process(data));
    setState(() {
      myData = result;
    });
  }
}
```

### 5.6 æœ€ä½³å®è·µä¸é€‰å‹å»ºè®®

**æœ€ä½³å®è·µï¼š**
1. ä¼˜å…ˆä½¿ç”¨ `Isolate.run` å¤„ç†ç®€å•ä»»åŠ¡
2. é¿å…æ•è·å¤§å¯¹è±¡æˆ–ä¸å¯åºåˆ—åŒ–å¯¹è±¡
3. å¯¹äºå¤æ‚å‚æ•°ï¼Œè€ƒè™‘ä½¿ç”¨ `compute`
4. å¯¹äºé•¿æœŸä»»åŠ¡ï¼Œä½¿ç”¨ `Isolate.spawn`

---

## å…­ã€Platform Channels + åŸç”Ÿçº¿ç¨‹æ·±åº¦è¯¦è§£

### 6.1 ä¸ºä»€ä¹ˆéœ€è¦åŸç”Ÿçº¿ç¨‹ï¼Ÿ

**Isolate æ— æ³•è§£å†³çš„åœºæ™¯ï¼š**
- éœ€è¦ä½¿ç”¨åŸç”Ÿåº“ï¼ˆå¦‚ OpenCVã€FFmpegï¼‰
- éœ€è¦è®¿é—®åŸç”Ÿå¹³å°ç‰¹æ€§
- éœ€è¦æè‡´æ€§èƒ½ï¼ˆé¿å… Dart VM å¼€é”€ï¼‰
- éœ€è¦ä¸ç°æœ‰åŸç”Ÿä»£ç é›†æˆ

### 6.2 Platform Channels æœºåˆ¶æ·±åº¦è§£æ

**ä¸‰ç§ Channel ç±»å‹ï¼š**

| Channel ç±»å‹ | é€šä¿¡æ¨¡å¼ | é€‚ç”¨åœºæ™¯ |
|-------------|---------|---------|
| MethodChannel | è¯·æ±‚-å“åº” | è°ƒç”¨åŸç”Ÿæ–¹æ³• |
| EventChannel | æµå¼ä¼ è¾“ | åŸç”Ÿäº‹ä»¶æµ |
| BasicMessageChannel | åŒå‘æ¶ˆæ¯ | è‡ªå®šä¹‰åè®® |

### 6.3 Android åŸç”Ÿçº¿ç¨‹å®ç°è¯¦è§£

```kotlin
// Android ç«¯ï¼šä½¿ç”¨ Executor å¤„ç†åå°ä»»åŠ¡
class MyPlugin : FlutterPlugin, MethodCallHandler {
    private val executor = Executors.newFixedThreadPool(4)

    override fun onMethodCall(call: MethodCall, result: Result) {
        when (call.method) {
            "processImage" -> {
                val imageData = call.argument<ByteArray>("data")

                // åœ¨åå°çº¿ç¨‹å¤„ç†
                executor.execute {
                    try {
                        val processed = processImageNative(imageData)

                        // å›åˆ°ä¸»çº¿ç¨‹è¿”å›ç»“æœ
                        Handler(Looper.getMainLooper()).post {
                            result.success(processed)
                        }
                    } catch (e: Exception) {
                        Handler(Looper.getMainLooper()).post {
                            result.error("ERROR", e.message, null)
                        }
                    }
                }
            }
        }
    }

    private fun processImageNative(data: ByteArray?): ByteArray {
        // åŸç”Ÿå›¾ç‰‡å¤„ç†é€»è¾‘
        return data ?: ByteArray(0)
    }
}
```

### 6.4 iOS åŸç”Ÿçº¿ç¨‹å®ç°è¯¦è§£

```swift
// iOS ç«¯ï¼šä½¿ç”¨ GCD å¤„ç†åå°ä»»åŠ¡
class MyPlugin: NSObject, FlutterPlugin {
    static func register(with registrar: FlutterPluginRegistrar) {
        let channel = FlutterMethodChannel(
            name: "my_plugin",
            binaryMessenger: registrar.messenger()
        )
        let instance = MyPlugin()
        registrar.addMethodCallDelegate(instance, channel: channel)
    }

    func handle(_ call: FlutterMethodCall, result: @escaping FlutterResult) {
        switch call.method {
        case "processImage":
            guard let args = call.arguments as? [String: Any],
                  let data = args["data"] as? FlutterStandardTypedData else {
                result(FlutterError(code: "INVALID_ARGS", message: nil, details: nil))
                return
            }

            // åœ¨åå°é˜Ÿåˆ—å¤„ç†
            DispatchQueue.global(qos: .userInitiated).async {
                let processed = self.processImageNative(data.data)

                // å›åˆ°ä¸»é˜Ÿåˆ—è¿”å›ç»“æœ
                DispatchQueue.main.async {
                    result(FlutterStandardTypedData(bytes: processed))
                }
            }

        default:
            result(FlutterMethodNotImplemented)
        }
    }

    private func processImageNative(_ data: Data) -> Data {
        // åŸç”Ÿå›¾ç‰‡å¤„ç†é€»è¾‘
        return data
    }
}
```

### 6.5 æ€§èƒ½ä¸ç»´æŠ¤æˆæœ¬åˆ†æ

**æ€§èƒ½ä¼˜åŠ¿ï¼š**
- é¿å… Dart VM å¼€é”€
- ç›´æ¥ä½¿ç”¨åŸç”Ÿä¼˜åŒ–åº“
- æ›´å¥½çš„ç¡¬ä»¶åŠ é€Ÿæ”¯æŒ

**ç»´æŠ¤æˆæœ¬ï¼š**
- éœ€è¦ç»´æŠ¤å¤šå¹³å°ä»£ç ï¼ˆAndroid + iOSï¼‰
- éœ€è¦å¤„ç†å¹³å°å·®å¼‚
- è°ƒè¯•æ›´å¤æ‚
- ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜

**æƒè¡¡å†³ç­–ï¼š**
- æ€§èƒ½æå‡ > 20% â†’ è€ƒè™‘ä½¿ç”¨
- å¿…é¡»ä½¿ç”¨åŸç”Ÿåº“ â†’ å¿…é¡»ä½¿ç”¨
- ç®€å•ä»»åŠ¡ â†’ ä¸å»ºè®®ä½¿ç”¨

### 6.6 å®æˆ˜åœºæ™¯ç¤ºä¾‹

**åœºæ™¯ï¼šé›†æˆåŸç”Ÿå›¾åƒå¤„ç†åº“**

```dart
// Flutter ç«¯
class NativeImageProcessor {
  static const platform = MethodChannel('image_processor');

  Future<Uint8List> processImage(Uint8List imageData) async {
    try {
      final result = await platform.invokeMethod('processImage', {
        'data': imageData,
      });
      return result as Uint8List;
    } catch (e) {
      throw Exception('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼š$e');
    }
  }
}
```

### 6.7 æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹

**æœ€ä½³å®è·µï¼š**
1. å§‹ç»ˆåœ¨åå°çº¿ç¨‹å¤„ç†è€—æ—¶æ“ä½œ
2. æ­£ç¡®å¤„ç†çº¿ç¨‹åˆ‡æ¢ï¼ˆå›åˆ°ä¸»çº¿ç¨‹è¿”å›ç»“æœï¼‰
3. å®Œå–„çš„é”™è¯¯å¤„ç†
4. æ³¨æ„å†…å­˜ç®¡ç†ï¼ˆç‰¹åˆ«æ˜¯ iOSï¼‰

**âš ï¸ æ³¨æ„äº‹é¡¹ï¼š**
- Platform Channels é€šä¿¡ä¹Ÿæœ‰å¼€é”€ï¼ˆ~1-5msï¼‰
- æ•°æ®éœ€è¦åºåˆ—åŒ–/ååºåˆ—åŒ–
- ä¸é€‚åˆé«˜é¢‘é€šä¿¡åœºæ™¯

---

## ä¸ƒã€æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹æŒ‡å—

### 7.1 å››å¤§æ–¹æ¡ˆç‰¹æ€§å¯¹æ¯”è¡¨

| ç‰¹æ€§ | Isolate.spawn | compute | Isolate.run | Platform Channels |
|------|--------------|---------|-------------|-------------------|
| æ˜“ç”¨æ€§ | â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­ |
| çµæ´»æ€§ | â­â­â­â­â­ | â­â­ | â­â­â­ | â­â­â­â­ |
| æ€§èƒ½ | â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| ç”Ÿå‘½å‘¨æœŸç®¡ç† | æ‰‹åŠ¨ | è‡ªåŠ¨ | è‡ªåŠ¨ | æ‰‹åŠ¨ |
| é€šä¿¡æ¨¡å¼ | åŒå‘ | å•å‘ | å•å‘ | åŒå‘ |
| å¯åŠ¨å¼€é”€ | 10-30ms | 10-30ms | 10-30ms | <1ms |
| ç»´æŠ¤æˆæœ¬ | ä¸­ | ä½ | ä½ | é«˜ |
| è·¨å¹³å° | âš ï¸ï¼ˆç§»åŠ¨/æ¡Œé¢ï¼‰ | âš ï¸ï¼ˆç§»åŠ¨/æ¡Œé¢ï¼‰ | âš ï¸ï¼ˆç§»åŠ¨/æ¡Œé¢ï¼‰ | âŒï¼ˆéœ€åŸç”Ÿä»£ç ï¼‰|
| ç‰ˆæœ¬è¦æ±‚ | æ‰€æœ‰ç‰ˆæœ¬ | æ‰€æœ‰ç‰ˆæœ¬ | Flutter 3.7+ | æ‰€æœ‰ç‰ˆæœ¬ |

> âš ï¸ **Web å¹³å°é™åˆ¶**ï¼šFlutter Web å½“å‰ä¸æ”¯æŒ `Isolate.spawn`ã€`compute` å’Œ `Isolate.run`ã€‚åœ¨ Web å¹³å°ä¸Šè°ƒç”¨è¿™äº› API ä¼šæŠ›å‡º `UnsupportedError`ã€‚
>
> **Web å¹³å°æ›¿ä»£æ–¹æ¡ˆï¼š**
> - ä½¿ç”¨ `async/await` å¤„ç†å¼‚æ­¥æ“ä½œï¼ˆä¸ä¼šé˜»å¡ UIï¼‰
> - ä½¿ç”¨ Web Workersï¼ˆéœ€è¦é€šè¿‡ `dart:html` æˆ– `package:web` å®ç°ï¼‰
> - å°†è®¡ç®—å¯†é›†å‹ä»»åŠ¡æ‹†åˆ†ä¸ºå°å—ï¼Œä½¿ç”¨ `Future.microtask` æˆ– `scheduleMicrotask` åˆ†æ‰¹å¤„ç†
> - è€ƒè™‘ä½¿ç”¨ WASM ç¼–è¯‘çš„åŸç”Ÿæ¨¡å—

### 7.2 æ€§èƒ½åŸºå‡†æµ‹è¯•

**æµ‹è¯•ç¯å¢ƒï¼š** iPhone 12 Pro, Android Pixel 5

| åœºæ™¯ | Isolate.spawn | compute | Isolate.run | Platform Channels |
|------|--------------|---------|-------------|-------------------|
| å›¾ç‰‡å‹ç¼©ï¼ˆ10MBï¼‰ | 520ms | 540ms | 540ms | 480ms |
| JSONè§£æï¼ˆ1MBï¼‰ | 180ms | 200ms | 200ms | 160ms |
| æ’åºï¼ˆ100ä¸‡æ•°æ®ï¼‰ | 350ms | 370ms | 370ms | 320ms |
| å¯åŠ¨å¼€é”€ | 15ms | 15ms | 15ms | <1ms |

**ç»“è®ºï¼š**
- Isolate æ–¹æ¡ˆæ€§èƒ½ç›¸è¿‘ï¼Œå·®å¼‚ä¸»è¦åœ¨æ˜“ç”¨æ€§
- Platform Channels æ€§èƒ½æœ€ä¼˜ï¼Œä½†ç»´æŠ¤æˆæœ¬é«˜
- å¯¹äºå¤§å¤šæ•°åœºæ™¯ï¼Œ`compute` æˆ– `Isolate.run` æ˜¯æœ€ä½³é€‰æ‹©

### 7.3 é€‰å‹å†³ç­–æ ‘

```
å¼€å§‹
  â”‚
  â”œâ”€ éœ€è¦ä½¿ç”¨åŸç”Ÿåº“ï¼Ÿ
  â”‚   â””â”€ æ˜¯ â†’ Platform Channels
  â”‚
  â”œâ”€ ä»»åŠ¡æ‰§è¡Œæ—¶é—´ < 50msï¼Ÿ
  â”‚   â””â”€ æ˜¯ â†’ ä¸»çº¿ç¨‹æ‰§è¡Œæˆ– async/await
  â”‚
  â”œâ”€ éœ€è¦é•¿æœŸè¿è¡Œçš„ Workerï¼Ÿ
  â”‚   â””â”€ æ˜¯ â†’ Isolate.spawn
  â”‚
  â”œâ”€ éœ€è¦åŒå‘é€šä¿¡ï¼Ÿ
  â”‚   â””â”€ æ˜¯ â†’ Isolate.spawn
  â”‚
  â”œâ”€ Flutter ç‰ˆæœ¬ >= 3.7ï¼Ÿ
  â”‚   â”œâ”€ æ˜¯ â†’ Isolate.runï¼ˆæ¨èï¼‰
  â”‚   â””â”€ å¦ â†’ compute
  â”‚
  â””â”€ é»˜è®¤ â†’ compute
```

### 7.4 åœºæ™¯æ¨èçŸ©é˜µ

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | å¤‡é€‰æ–¹æ¡ˆ | ä¸æ¨è |
|------|---------|---------|--------|
| å›¾ç‰‡å‹ç¼© | compute | Isolate.run | Platform Channels* |
| å›¾ç‰‡æ»¤é•œ | compute | Platform Channels | - |
| JSON è§£æ | compute | Isolate.run | - |
| æ•°æ®åŠ å¯† | compute | Isolate.run | - |
| å®æ—¶è§†é¢‘å¤„ç† | Platform Channels | - | Isolate |
| æ‰¹é‡æ–‡ä»¶å¤„ç† | Isolate.spawn | compute | - |
| ç½‘ç»œè¯·æ±‚ | async/await | - | Isolate |
| æ•°æ®åº“æŸ¥è¯¢ | async/await | - | Isolate |

*é™¤ééœ€è¦ä½¿ç”¨åŸç”Ÿå›¾åƒå¤„ç†åº“

### 7.5 ä¸åŸç”Ÿå¹³å°å¯¹æ¯”

**Flutter Isolate vs Android Threadï¼š**

| ç‰¹æ€§ | Flutter Isolate | Android Thread |
|------|----------------|----------------|
| å†…å­˜æ¨¡å‹ | éš”ç¦» | å…±äº« |
| çº¿ç¨‹å®‰å…¨ | å¤©ç„¶å®‰å…¨ | éœ€è¦é” |
| é€šä¿¡æ–¹å¼ | æ¶ˆæ¯ä¼ é€’ | å…±äº«å†…å­˜ |
| å­¦ä¹ æ›²çº¿ | å¹³ç¼“ | é™¡å³­ |
| è°ƒè¯•éš¾åº¦ | ä¸­ç­‰ | å›°éš¾ |

**Flutter Isolate vs iOS GCDï¼š**

| ç‰¹æ€§ | Flutter Isolate | iOS GCD |
|------|----------------|---------|
| æŠ½è±¡å±‚æ¬¡ | é«˜ | ä¸­ |
| æ˜“ç”¨æ€§ | å¥½ | å¾ˆå¥½ |
| æ€§èƒ½ | å¥½ | ä¼˜ç§€ |
| è·¨å¹³å° | âœ… | âŒ |

---

## å…«ã€å®é™…åº”ç”¨åœºæ™¯æ·±åº¦è¯¦è§£

### 8.1 å›¾ç‰‡å¤„ç†åœºæ™¯

**åœºæ™¯æè¿°ï¼š** ç”¨æˆ·ä¸Šä¼  4000Ã—3000 åƒç´ ç…§ç‰‡ï¼Œéœ€è¦å‹ç¼©å¹¶åº”ç”¨æ»¤é•œã€‚

**æ–¹æ¡ˆé€‰æ‹©ï¼š** computeï¼ˆç®€å•æ˜“ç”¨ï¼Œæ€§èƒ½è¶³å¤Ÿï¼‰

**å®Œæ•´å®ç°ï¼š**

```dart
import 'dart:typed_data';
import 'package:flutter/foundation.dart';
import 'package:image/image.dart' as img;

class ImageProcessor {
  Future<Uint8List> processImage({
    required Uint8List imageData,
    required int quality,
    required String filterType,
  }) async {
    return await compute(_processInBackground, {
      'imageData': imageData,
      'quality': quality,
      'filterType': filterType,
    });
  }

  static Uint8List _processInBackground(Map<String, dynamic> params) {
    final imageData = params['imageData'] as Uint8List;
    final quality = params['quality'] as int;
    final filterType = params['filterType'] as String;

    // è§£ç å›¾ç‰‡
    var image = img.decodeImage(imageData);
    if (image == null) throw Exception('æ— æ³•è§£ç å›¾ç‰‡');

    // åº”ç”¨æ»¤é•œ
    switch (filterType) {
      case 'grayscale':
        image = img.grayscale(image);
        break;
      case 'sepia':
        image = img.sepia(image);
        break;
    }

    // å‹ç¼©å¹¶ç¼–ç 
    return Uint8List.fromList(img.encodeJpg(image, quality: quality));
  }
}
```

**æ€§èƒ½ä¼˜åŒ–ï¼š**
- ä½¿ç”¨ `Uint8List` ä¼ é€’å›¾ç‰‡æ•°æ®ï¼ˆé›¶æ‹·è´ï¼‰
- æ‰¹é‡å¤„ç†å¤šå¼ å›¾ç‰‡
- å¤ç”¨ Workerï¼ˆå¦‚æœé¢‘ç¹å¤„ç†ï¼‰

### 8.2 å¤§æ•°æ®è§£æåœºæ™¯

**åœºæ™¯æè¿°ï¼š** è§£æ 5MB çš„ JSON æ•°æ®ï¼ŒåŒ…å« 10000 æ¡è®°å½•ã€‚

**æ–¹æ¡ˆé€‰æ‹©ï¼š** compute

**å®Œæ•´å®ç°ï¼š**

```dart
import 'dart:convert';

Future<List<Product>> parseProducts(String jsonString) async {
  // æ£€æŸ¥æ•°æ®å¤§å°
  if (jsonString.length < 100000) {
    // å°æ•°æ®ï¼Œä¸»çº¿ç¨‹å¤„ç†
    return _parseProductsSync(jsonString);
  }

  // å¤§æ•°æ®ï¼Œåå°å¤„ç†
  return await compute(_parseProductsInBackground, jsonString);
}

List<Product> _parseProductsSync(String jsonString) {
  final List<dynamic> jsonList = jsonDecode(jsonString);
  return jsonList.map((json) => Product.fromJson(json)).toList();
}

List<Product> _parseProductsInBackground(String jsonString) {
  return _parseProductsSync(jsonString);
}
```

**å¸¸è§é”™è¯¯ï¼šåœ¨ä¸»çº¿ç¨‹è§£æå¤§æ•°æ®**

```dart
// âŒ é”™è¯¯ï¼šUI ä¼šå¡é¡¿
void loadData() {
  final data = jsonDecode(largeJsonString); // é˜»å¡ UI
  setState(() => products = data);
}

// âœ… æ­£ç¡®ï¼šåå°è§£æ
Future<void> loadData() async {
  final data = await compute(jsonDecode, largeJsonString);
  setState(() => products = data);
}
```

### 8.3 æ•°æ®åº“æ“ä½œåœºæ™¯

**åœºæ™¯æè¿°ï¼š** æ‰¹é‡æ’å…¥ 10000 æ¡è®°å½•åˆ° SQLiteã€‚

**æ–¹æ¡ˆé€‰æ‹©ï¼š** async/awaitï¼ˆæ•°æ®åº“æ“ä½œæ˜¯ I/O å¯†é›†å‹ï¼‰

**å®Œæ•´å®ç°ï¼š**

```dart
import 'package:sqflite/sqflite.dart';

class DatabaseService {
  Future<void> batchInsert(List<Product> products) async {
    final db = await database;

    // âœ… ä½¿ç”¨äº‹åŠ¡æ‰¹é‡æ’å…¥
    await db.transaction((txn) async {
      final batch = txn.batch();

      for (var product in products) {
        batch.insert('products', product.toMap());
      }

      await batch.commit(noResult: true);
    });
  }
}
```

**âš ï¸ æ³¨æ„ï¼š** æ•°æ®åº“æ“ä½œä¸éœ€è¦ Isolateï¼Œå› ä¸ºå®ƒæ˜¯ I/O æ“ä½œï¼Œä¸ä¼šé˜»å¡ CPUã€‚

### 8.4 åŠ å¯†è§£å¯†åœºæ™¯

**åœºæ™¯æè¿°ï¼š** AES åŠ å¯† 10MB æ–‡ä»¶ã€‚

**æ–¹æ¡ˆé€‰æ‹©ï¼š** compute

```dart
import 'package:encrypt/encrypt.dart';

Future<Uint8List> encryptFile(Uint8List fileData, String password) async {
  return await compute(_encryptInBackground, {
    'data': fileData,
    'password': password,
  });
}

Uint8List _encryptInBackground(Map<String, dynamic> params) {
  final data = params['data'] as Uint8List;
  final password = params['password'] as String;

  final key = Key.fromUtf8(password.padRight(32, '0').substring(0, 32));
  final iv = IV.fromLength(16);
  final encrypter = Encrypter(AES(key));

  return encrypter.encryptBytes(data, iv: iv).bytes;
}
```

---

## ä¹ã€æœ€ä½³å®è·µä¸å¸¸è§é™·é˜±æ·±åº¦è§£æ

### 9.1 ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ€ä½³å®è·µ

**åœ¨ Widget ä¸­ä½¿ç”¨ Isolateï¼š**

```dart
class MyWidget extends StatefulWidget {
  @override
  _MyWidgetState createState() => _MyWidgetState();
}

class _MyWidgetState extends State<MyWidget> {
  Isolate? _isolate;
  SendPort? _sendPort;

  @override
  void initState() {
    super.initState();
    _initIsolate();
  }

  Future<void> _initIsolate() async {
    final receivePort = ReceivePort();
    _isolate = await Isolate.spawn(_worker, receivePort.sendPort);
    _sendPort = await receivePort.first as SendPort;
  }

  @override
  void dispose() {
    // âœ… æ¸…ç† Isolate
    _isolate?.kill();
    super.dispose();
  }

  static void _worker(SendPort mainSendPort) {
    // Worker é€»è¾‘
  }

  @override
  Widget build(BuildContext context) => Container();
}
```

### 9.2 å†…å­˜æ³„æ¼é˜²æ­¢

**å¸¸è§æ³„æ¼åœºæ™¯ï¼š**

1. **å¿˜è®°å…³é—­ ReceivePort**
2. **å¿˜è®°ç»ˆæ­¢ Isolate**
3. **å¾ªç¯å¼•ç”¨**

**æ£€æµ‹æ–¹æ³•ï¼š**

```dart
// ä½¿ç”¨ DevTools çš„ Memory Profiler
// 1. æ‰“å¼€ DevTools
// 2. åˆ‡æ¢åˆ° Memory æ ‡ç­¾
// 3. æ‰§è¡Œæ“ä½œ
// 4. ç‚¹å‡» GC æŒ‰é’®
// 5. æŸ¥çœ‹å†…å­˜æ˜¯å¦é‡Šæ”¾
```

### 9.3 çº¿ç¨‹å®‰å…¨ä¸æ•°æ®å…±äº«

**Isolate çš„ä¼˜åŠ¿ï¼š**

```dart
// âœ… Isolateï¼šå¤©ç„¶çº¿ç¨‹å®‰å…¨
int counter = 0;

void isolateWorker(SendPort mainSendPort) {
  // æ¯ä¸ª Isolate æœ‰ç‹¬ç«‹çš„ counter
  counter++; // å®‰å…¨
}

// âŒ ä¼ ç»Ÿçº¿ç¨‹ï¼šéœ€è¦é”
class Counter {
  int _value = 0;

  synchronized void increment() {
    _value++; // éœ€è¦åŒæ­¥
  }
}
```

### 9.4 é”™è¯¯å¤„ç†ç­–ç•¥

**å®Œæ•´çš„é”™è¯¯å¤„ç†ï¼š**

```dart
Future<Result> safeCompute<T, R>(
  ComputeCallback<T, R> callback,
  T message,
) async {
  try {
    final result = await compute(callback, message);
    return Result.success(result);
  } on Exception catch (e) {
    return Result.error('è®¡ç®—å¤±è´¥ï¼š$e');
  } catch (e) {
    return Result.error('æœªçŸ¥é”™è¯¯ï¼š$e');
  }
}
```

### 9.5 æ€§èƒ½è°ƒä¼˜æŠ€å·§

**æŠ€å·§1ï¼šé¿å…é¢‘ç¹åˆ›å»º Isolate**

```dart
// âŒ ä½æ•ˆ
for (var item in items) {
  await compute(process, item); // åˆ›å»º N æ¬¡
}

// âœ… é«˜æ•ˆ
await compute(processAll, items); // åˆ›å»º 1 æ¬¡
```

**æŠ€å·§2ï¼šä½¿ç”¨ Worker Pool**

```dart
final pool = IsolatePool(workerCount: 4);
await pool.init();

// å¹¶è¡Œå¤„ç†
final results = await Future.wait(
  items.map((item) => pool.execute(item)),
);
```

### 9.6 è°ƒè¯•æ–¹æ³•ä¸å·¥å…·

**ä½¿ç”¨ DevToolsï¼š**

1. **Timeline æ ‡ç­¾**ï¼šæŸ¥çœ‹ Isolate åˆ›å»ºå’Œé”€æ¯
2. **Memory æ ‡ç­¾**ï¼šæ£€æµ‹å†…å­˜æ³„æ¼
3. **Logging æ ‡ç­¾**ï¼šæŸ¥çœ‹æ—¥å¿—è¾“å‡º

**è°ƒè¯•æŠ€å·§ï¼š**

```dart
// æ·»åŠ è°ƒè¯•æ—¥å¿—
void _worker(SendPort mainSendPort) {
  print('[Worker] å¯åŠ¨');

  // å¤„ç†é€»è¾‘...

  print('[Worker] å®Œæˆ');
}
```

### 9.7 å¸¸è§é”™è¯¯ä¸è§£å†³æ–¹æ¡ˆ

**é”™è¯¯1ï¼šä¼ é€’ä¸å¯åºåˆ—åŒ–å¯¹è±¡**
- è§£å†³ï¼šåªä¼ é€’åŸºæœ¬ç±»å‹å’Œé›†åˆ

**é”™è¯¯2ï¼šå¿˜è®°é‡Šæ”¾èµ„æº**
- è§£å†³ï¼šä½¿ç”¨ try-finally ç¡®ä¿æ¸…ç†

**é”™è¯¯3ï¼šè¿‡åº¦ä½¿ç”¨ Isolate**
- è§£å†³ï¼šè¯„ä¼°ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼Œ< 50ms ä¸ä½¿ç”¨

**é”™è¯¯4ï¼šåœ¨ Isolate ä¸­è®¿é—® UI**
- è§£å†³ï¼šé€šè¿‡æ¶ˆæ¯ä¼ é€’æ•°æ®ï¼Œåœ¨ä¸»çº¿ç¨‹æ›´æ–° UI

**é”™è¯¯5ï¼šæ­»é”**
- è§£å†³ï¼šè®¾è®¡æ¸…æ™°çš„é€šä¿¡æµç¨‹ï¼Œé¿å…å¾ªç¯ç­‰å¾…

### 9.8 è·¨å¹³å°å·®å¼‚æ³¨æ„äº‹é¡¹

**Web å¹³å°é™åˆ¶ï¼š**
- ä¸æ”¯æŒ `Isolate.spawn`
- å¯ä»¥ä½¿ç”¨ Web Workersï¼ˆé€šè¿‡ `dart:html`ï¼‰

**Desktop å¹³å°ç‰¹æ€§ï¼š**
- Isolate æ€§èƒ½æ›´å¥½ï¼ˆæ›´å¤š CPU æ ¸å¿ƒï¼‰
- å¯ä»¥åˆ›å»ºæ›´å¤š Worker

**Mobile å¹³å°ä¼˜åŒ–ï¼š**
- æ³¨æ„ç”µæ± æ¶ˆè€—
- é¿å…åˆ›å»ºè¿‡å¤š Isolate
- åœ¨åå°æ—¶æš‚åœ Worker

---

## åã€é™„å½•

### 10.1 API é€ŸæŸ¥è¡¨

#### Isolate æ ¸å¿ƒ API

| API | åŠŸèƒ½ | ç¤ºä¾‹ |
|-----|------|------|
| `Isolate.spawn()` | åˆ›å»ºæ–° Isolate | `await Isolate.spawn(worker, data)` |
| `Isolate.kill()` | ç»ˆæ­¢ Isolate | `isolate.kill()` |
| `Isolate.pause()` | æš‚åœ Isolate | `isolate.pause()` |
| `Isolate.resume()` | æ¢å¤ Isolate | `isolate.resume(capability)` |
| `ReceivePort()` | åˆ›å»ºæ¥æ”¶ç«¯å£ | `final port = ReceivePort()` |
| `SendPort.send()` | å‘é€æ¶ˆæ¯ | `sendPort.send(message)` |

#### compute å‡½æ•° API

| API | åŠŸèƒ½ | ç¤ºä¾‹ |
|-----|------|------|
| `compute()` | åœ¨åå°æ‰§è¡Œå‡½æ•° | `await compute(func, data)` |

#### Isolate.run API (Flutter 3.7+)

| API | åŠŸèƒ½ | ç¤ºä¾‹ |
|-----|------|------|
| `Isolate.run()` | åœ¨åå°æ‰§è¡Œé—­åŒ… | `await Isolate.run(() => task())` |

#### Platform Channels API

| API | åŠŸèƒ½ | ç¤ºä¾‹ |
|-----|------|------|
| `MethodChannel` | æ–¹æ³•è°ƒç”¨ | `const MethodChannel('name')` |
| `EventChannel` | äº‹ä»¶æµ | `const EventChannel('name')` |
| `invokeMethod()` | è°ƒç”¨åŸç”Ÿæ–¹æ³• | `await channel.invokeMethod('method')` |

### 10.2 ä¸åŸç”Ÿå¹³å°å¯¹æ¯”è¡¨

#### Flutter vs Android

| æ¦‚å¿µ | Flutter | Android |
|------|---------|---------|
| çº¿ç¨‹ | Isolate | Thread |
| çº¿ç¨‹æ±  | Worker Pool | ThreadPoolExecutor |
| ä¸»çº¿ç¨‹ | Main Isolate | UI Thread |
| åå°ä»»åŠ¡ | compute | AsyncTask (å·²åºŸå¼ƒ) |
| æ¶ˆæ¯ä¼ é€’ | SendPort/ReceivePort | Handler/Looper |
| çº¿ç¨‹å®‰å…¨ | å¤©ç„¶å®‰å…¨ï¼ˆéš”ç¦»ï¼‰ | éœ€è¦é” |

#### Flutter vs iOS

| æ¦‚å¿µ | Flutter | iOS |
|------|---------|-----|
| çº¿ç¨‹ | Isolate | Thread |
| å¹¶å‘é˜Ÿåˆ— | Worker Pool | DispatchQueue |
| ä¸»çº¿ç¨‹ | Main Isolate | Main Queue |
| åå°ä»»åŠ¡ | compute | DispatchQueue.global() |
| æ¶ˆæ¯ä¼ é€’ | SendPort/ReceivePort | NotificationCenter |
| çº¿ç¨‹å®‰å…¨ | å¤©ç„¶å®‰å…¨ï¼ˆéš”ç¦»ï¼‰ | éœ€è¦åŒæ­¥ |

### 10.3 æ€§èƒ½åŸºå‡†æ•°æ®æ±‡æ€»

#### å¯åŠ¨å¼€é”€å¯¹æ¯”

| æ“ä½œ | æ—¶é—´ï¼ˆmsï¼‰ | è¯´æ˜ |
|------|-----------|------|
| åˆ›å»º Isolate | 10-30 | åŒ…å«å†…å­˜åˆ†é…ã€çº¿ç¨‹åˆ›å»º |
| åˆ›å»º compute | 10-30 | ä¸ Isolate ç›¸åŒ |
| åˆ›å»º Isolate.run | 10-30 | ä¸ Isolate ç›¸åŒ |
| Platform Channel è°ƒç”¨ | <1 | æ— éœ€åˆ›å»ºçº¿ç¨‹ |

#### æ•°æ®ä¼ é€’å¼€é”€

| æ•°æ®ç±»å‹ | å¤§å° | ä¼ é€’æ—¶é—´ï¼ˆmsï¼‰ | è¯´æ˜ |
|---------|------|---------------|------|
| int | 4 bytes | <1 | åŸºæœ¬ç±»å‹ |
| String (1KB) | 1 KB | <1 | å°å­—ç¬¦ä¸² |
| List<int> (100ä¸‡) | ~4 MB | 100-150 | éœ€è¦åºåˆ—åŒ– |
| Uint8List (100ä¸‡) | ~1 MB | 20-30 | æ™®é€š SendPort å¤åˆ¶æ•´å—å†…å­˜ |
| TransferableTypedData (100ä¸‡) | ~1 MB | 1-5 | çœŸæ­£é›¶æ‹·è´ï¼Œä¸€æ¬¡æ€§ |
| Map (1ä¸‡é”®å€¼å¯¹) | ~200 KB | 30-50 | éœ€è¦åºåˆ—åŒ– |

#### å®é™…åœºæ™¯æ€§èƒ½

| åœºæ™¯ | æ•°æ®é‡ | å¤„ç†æ—¶é—´ï¼ˆmsï¼‰ | æ¨èæ–¹æ¡ˆ |
|------|--------|---------------|---------|
| å›¾ç‰‡å‹ç¼© | 10 MB | 500-600 | compute |
| JSON è§£æ | 1 MB | 180-220 | compute |
| æ•°æ®æ’åº | 100ä¸‡æ¡ | 350-400 | compute |
| æ–‡ä»¶åŠ å¯† | 10 MB | 800-1000 | compute |
| æ•°æ®åº“æŸ¥è¯¢ | 1ä¸‡æ¡ | 50-100 | async/await |

### 10.4 å‚è€ƒèµ„æ–™

#### å®˜æ–¹æ–‡æ¡£

- [Dart Isolates å®˜æ–¹æ–‡æ¡£](https://dart.dev/guides/language/concurrency)
- [Flutter compute å‡½æ•°æ–‡æ¡£](https://api.flutter.dev/flutter/foundation/compute.html)
- [Platform Channels æ–‡æ¡£](https://docs.flutter.dev/development/platform-integration/platform-channels)

#### ç›¸å…³æŠ€æœ¯æ–‡ç« 

- Dart å¹¶å‘ç¼–ç¨‹æ¨¡å‹è¯¦è§£
- Flutter æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ
- Isolate vs Thread æ·±åº¦å¯¹æ¯”

#### å¼€æºé¡¹ç›®æ¨è

- `isolate_handler` - Isolate ç®¡ç†åº“
- `worker_manager` - Worker Pool å®ç°
- `flutter_isolate` - å¢å¼ºçš„ Isolate å·¥å…·

### 10.5 æœ€ä½³å®è·µæ¸…å•

#### è®¾è®¡é˜¶æ®µæ£€æŸ¥æ¸…å•

- [ ] ç¡®è®¤ä»»åŠ¡æ˜¯ CPU å¯†é›†å‹è¿˜æ˜¯ I/O å¯†é›†å‹
- [ ] è¯„ä¼°ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼ˆæ˜¯å¦ > 50msï¼‰
- [ ] ç¡®å®šæ˜¯å¦éœ€è¦åŒå‘é€šä¿¡
- [ ] ç¡®å®šæ˜¯å¦éœ€è¦é•¿æœŸè¿è¡Œçš„ Worker
- [ ] é€‰æ‹©åˆé€‚çš„å¤šçº¿ç¨‹æ–¹æ¡ˆ

#### å®ç°é˜¶æ®µæ£€æŸ¥æ¸…å•

- [ ] ç¡®ä¿ä¼ é€’çš„æ•°æ®å¯åºåˆ—åŒ–
- [ ] ä½¿ç”¨ TypedData ä¼ é€’å¤§å‹æ•°æ®
- [ ] å®ç°å®Œæ•´çš„é”™è¯¯å¤„ç†
- [ ] æ·»åŠ è°ƒè¯•æ—¥å¿—
- [ ] è€ƒè™‘æ‰¹é‡å¤„ç†ä¼˜åŒ–

#### æµ‹è¯•é˜¶æ®µæ£€æŸ¥æ¸…å•

- [ ] æµ‹è¯•ä¸åŒæ•°æ®é‡ä¸‹çš„æ€§èƒ½
- [ ] æµ‹è¯•é”™è¯¯åœºæ™¯
- [ ] ä½¿ç”¨ DevTools æ£€æµ‹å†…å­˜æ³„æ¼
- [ ] æµ‹è¯•åœ¨ä¸åŒå¹³å°çš„è¡¨ç°
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆå¤§é‡å¹¶å‘ä»»åŠ¡ï¼‰

#### ä¸Šçº¿å‰æ£€æŸ¥æ¸…å•

- [ ] ç¡®ä¿æ‰€æœ‰ ReceivePort éƒ½è¢«å…³é—­
- [ ] ç¡®ä¿æ‰€æœ‰ Isolate éƒ½è¢«æ­£ç¡®ç»ˆæ­¢
- [ ] ç§»é™¤è°ƒè¯•æ—¥å¿—
- [ ] æ·»åŠ æ€§èƒ½ç›‘æ§
- [ ] æ–‡æ¡£åŒ–å¤šçº¿ç¨‹ä½¿ç”¨åœºæ™¯

---

## æ€»ç»“

æœ¬æ–‡æ¡£æ·±å…¥è®²è§£äº† Flutter å¤šçº¿ç¨‹ç¼–ç¨‹çš„å››å¤§æ–¹æ¡ˆï¼š

1. **Isolate.spawn** - æœ€çµæ´»ï¼Œé€‚åˆå¤æ‚åœºæ™¯
2. **compute** - æœ€ç®€å•ï¼Œé€‚åˆä¸€æ¬¡æ€§ä»»åŠ¡
3. **Isolate.run** - Flutter 3.7+ æ–°ç‰¹æ€§ï¼Œæ›´çµæ´»
4. **Platform Channels** - æ€§èƒ½æé™ï¼Œéœ€è¦åŸç”Ÿä»£ç 

**æ ¸å¿ƒè¦ç‚¹ï¼š**
- ç†è§£ Isolate çš„å†…å­˜éš”ç¦»æ¨¡å‹
- åŒºåˆ†å¼‚æ­¥ï¼ˆasync/awaitï¼‰å’Œå¹¶å‘ï¼ˆIsolateï¼‰
- æŒæ¡æ¶ˆæ¯ä¼ é€’æœºåˆ¶
- æ­£ç¡®ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
- é¿å…å¸¸è§é™·é˜±

**é€‰å‹å»ºè®®ï¼š**
- ç®€å•ä»»åŠ¡ â†’ `compute` æˆ– `Isolate.run`
- å¤æ‚ä»»åŠ¡ â†’ `Isolate.spawn`
- åŸç”Ÿæ€§èƒ½ â†’ `Platform Channels`
- I/O æ“ä½œ â†’ `async/await`

å¸Œæœ›æœ¬æ–‡æ¡£èƒ½å¸®åŠ©æ‚¨æ·±å…¥ç†è§£ Flutter å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­åšå‡ºæ˜æ™ºçš„æŠ€æœ¯é€‰å‹ï¼

---

_æ–‡æ¡£ç‰ˆæœ¬ï¼š1.0 | æœ€åæ›´æ–°ï¼š2026-01-05_

